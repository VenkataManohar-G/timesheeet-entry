sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/core/library","sap/ui/export/library","sap/m/library","sap/m/Dialog","sap/m/Button","sap/m/Text","sap/ui/model/Sorter","sap/ui/model/Filter","sap/m/SearchField","sap/ui/table/Column","sap/m/Column","sap/m/Label","sap/ui/model/type/String","sap/ui/comp/library","sap/ui/model/FilterOperator","sap/ui/core/Fragment","sap/ui/core/message/Message","sap/ushell/Container","sap/ui/export/Spreadsheet","sap/m/MessageBox"],(e,t,a,s,i,n,r,l,o,d,g,m,u,h,p,c,w,f,T,D,y)=>{"use strict";var v,b,_=[],S=[],V=[],M=0,I=0,E=0,x,W,C;var P,k,R,F,B,H,O,N,A,j,J,L,j,Q,K,U,z,G;var Y=t.MessageType,Z=s.DialogType,$=s.ButtonType;var X,q,ee,te,ae,se,ie,ne,re,le,oe,de,ge,me,ue;var he=t.ValueState,pe=a.EdmType;var ce=new sap.ui.model.json.JSONModel,we=new sap.ui.model.json.JSONModel;var fe,Te;var De,ye,ve="X";return e.extend("timesheetentry.controller.timesheet_view",{formatWbsElement:function(e){var t,a;if(e){t=e.toString();a=t.padStart(8,"0");return a}},formatStatus:function(e){if(e==="30"){return"Success"}else if(e==="10"){return"Information"}else{return"Error"}},shellDetails:function(){var e;if(sap.ushell&&sap.ushell.Container){var t=sap.ushell.Container.getService("UserInfo");if(t){e=t.getEmail();if(!e){e="rkirlampudi@answerthink.com"}}else{e="rkirlampudi@answerthink.com"}}else{e="rkirlampudi@answerthink.com"}return e},UserDetails:async function(e){oe=await this.shellDetails();if(oe){this._getuserdetails(oe)}},_getuserdetails:function(e){var t=[];var a,s,l;l=new sap.ui.model.Filter("Email","EQ",e);e;t.push(l);var o=new sap.m.BusyDialog({title:"Loading Data",text:"Please wait....."});o.open();B=this.getOwnerComponent().getModel("EmployeeService");B.read("/MyEmployeeData",{filters:t,urlParameters:{$top:999999},success:function(e){var t={};var a=this.getView().byId("id_employee_extid");var s=this.getView().byId("id_wrkid_add");var l=this.getView().byId("id_ccenter_add");var d=this.getView().byId("id_search");var g,m;L=new sap.ui.model.json.JSONModel;var u=this;if(e.results.length!==0){t=e.results;if(t.length!==0){L.setData(e.results);u.getView().setModel(L,"CompanyCodes");a.setText(t[0].PersonWorkAgreementExternalID);re=t[0].PersonWorkAgreement;if(t[0].PersonFullName){g=t[0].PersonWorkAgreement+" ("+t[0].PersonFullName+")";s.setText(g);s.setVisible(true)}else{g=t[0].PersonWorkAgreement;s.setText(g);s.setVisible(true)}if(t[0].CostCenterDescription){m=t[0].CostCenter+" ("+t[0].CostCenterDescription+")";l.setText(m);l.setVisible(true)}else{m=t[0].CostCenter;l.setText(m);l.setVisible(true)}if(t.length===1){de=t[0].CompanyCode;ge=t[0].CompanyCodeName}d.setEnabled(true)}else{this.oReadSuccessMessageDialog=new i({type:Z.Message,title:"Information",state:he.Warning,content:new r({text:"No Data Found with the Selected Company Code!!..Please try with another"}),beginButton:new n({type:$.Emphasized,text:"Ok",press:function(){s.setText("");a.setText("");l.setText("");d.setEnabled(false);this.oReadSuccessMessageDialog.close()}.bind(this)})});this.oReadSuccessMessageDialog.open()}}else{this.oReadSuccessMessageDialog=new i({type:Z.Message,title:"Information",state:he.Warning,content:new r({text:"No Employee Found"}),beginButton:new n({type:$.Emphasized,text:"Ok",press:function(){s.setText("");a.setText("");l.setText("");d.setEnabled(false);this.oReadSuccessMessageDialog.close()}.bind(this)})});this.oReadSuccessMessageDialog.open()}o.close()}.bind(this),error:function(e){this.oReadErrorMessageDialog=new i({type:Z.Message,title:"Error",state:he.Error,content:new r({text:""+e+""}),beginButton:new n({type:$.Emphasized,text:"Ok",press:function(){this.oReadErrorMessageDialog.close()}.bind(this)})});this.oReadErrorMessageDialog.open();o.close()}.bind(this)})},onInit(){var e=this;this.UserDetails();P=this.getOwnerComponent().getModel();N=this.getOwnerComponent().getModel("TaskTypeService");A=this.getOwnerComponent().getModel("TimesheetService");e.getView().setModel(N,"Tasks");j=this.getOwnerComponent().getModel("TemplateJSONData");e.getView().setModel(j,"Template");Q=new sap.ui.model.json.JSONModel({start:"",end:""});e.getView().setModel(Q,"DateModel");C=this.getOwnerComponent().getModel("configurationModel");this.dateTimePeriod();this._configSettings();G=this.getView().getModel("i18n");F=new sap.ui.model.json.JSONModel({bHideColumn:true});e.getView().setModel(F,"FieldProperty")},_configSettings:function(){var e=this;R=new sap.ui.model.json.JSONModel;var t={};t.Checked=true;t.Id="1";t.Field="Task Type";S.push(t);var t={};t.Checked=false;t.Id="2";t.Field="Employee Wbs Element";S.push(t);var t={};t.Checked=true;t.Id="3";t.Field="Wbs Element";S.push(t);R.setData(S);e.getView().setModel(R,"Settings");R.refresh(true)},dateTimePeriod:function(){var e=new Date;var t=e.getDay();var a=this;if(t===6){var s=new Date(new Date(e).getTime()+5184e5);K=new sap.ui.model.json.JSONModel({start:e,end:new Date(new Date(e).getTime()+5184e5)});K.refresh();a.getView().setModel(K,"DateModel1")}else if(t===5){K=new sap.ui.model.json.JSONModel({start:new Date(new Date(e).getTime()-5184e5),end:e});K.refresh();a.getView().setModel(K,"DateModel1")}else if(t===4){K=new sap.ui.model.json.JSONModel({start:new Date(new Date(e).getTime()-432e6),end:new Date(new Date(e).getTime()+864e5)});K.refresh();a.getView().setModel(K,"DateModel1")}else if(t===3){K=new sap.ui.model.json.JSONModel({start:new Date(new Date(e).getTime()-3456e5),end:new Date(new Date(e).getTime()+1728e5)});K.refresh();a.getView().setModel(K,"DateModel1")}else if(t===2){K=new sap.ui.model.json.JSONModel({start:new Date(new Date(e).getTime()-2592e5),end:new Date(new Date(e).getTime()+2592e5)});K.refresh();a.getView().setModel(K,"DateModel1")}else if(t===1){K=new sap.ui.model.json.JSONModel({start:new Date(new Date(e).getTime()-1728e5),end:new Date(new Date(e).getTime()+3456e5)});K.refresh();a.getView().setModel(K,"DateModel1")}else if(t===0){K=new sap.ui.model.json.JSONModel({start:new Date(new Date(e).getTime()-864e5),end:new Date(new Date(e).getTime()+432e6)});K.refresh();a.getView().setModel(K,"DateModel1")}},_datediff:function(e,t){const a=1e3*60*60*24;const s=Date.UTC(e.getFullYear(),e.getMonth(),e.getDate());const i=Date.UTC(t.getFullYear(),t.getMonth(),t.getDate());return Math.floor((i-s)/a)},handleDateChange:function(e){var t=this.getView().byId("id_search");var a=[],s=e.getParameter("from"),i=e.getParameter("to"),n=e.getParameter("value"),r=e.getParameter("valid"),l=e.getSource();if(r){l.setValueState(he.None);a=n.split("â€“");if(a.length>1){x=a[0].trim();W=a[1].trim();var o=this._datediff(s,i);if(o>60){l.setValueState(he.Error);l.setValueStateText("Date Range shouldn't exceed more than 60 days");t.setEnabled(false)}else{l.setValueState(he.None);l.setValueStateText("");t.setEnabled(true)}}else{x=a[0].trim();W=a[0].trim();t.setEnabled(true)}}else{l.setValueState(he.Error);l.setValueStateText("Invalid Date");t.setEnabled(false)}},onFilter:function(e){var t=this.getView().byId("id_employee_extid");var a=t.getText();var s=x;var l=W;if(a===""||s===undefined||l===undefined||s===""||l===""){this.oFillMessageDialog=new i({type:Z.Message,title:"Error",state:he.Error,content:new r({text:"Employee Id & Date are Mandatory"}),beginButton:new n({type:$.Emphasized,text:"Ok",press:function(){this.oFillMessageDialog.close()}.bind(this)})});this.oFillMessageDialog.open()}else{this._bindtimesheet(a,s,l)}},_bindtimesheet:function(e,t,a){var s=[];var i,n,r,l,o,d,g;n=this;i=new sap.ui.model.json.JSONModel;l=new sap.ui.model.Filter("PersonWorkAgreementExternalID","EQ",e);s.push(l);if(t&&a){var m=t+"T00:00:00Z";var u=a+"T23:59:59Z";var h=new sap.ui.model.Filter("TimeSheetDate","BT",m,u);s.push(h)}else if(t){var p=t+"T00:00:00Z";var u=t+"T23:59:59Z";var h=new sap.ui.model.Filter("TimeSheetDate","BT",p,u);s.push(h)}var c=new sap.m.BusyDialog({title:"Loading Data",text:"Please wait....."});c.open();P.read("/MyTimesheetDetails",{filters:s,urlParameters:{$top:999999},success:function(e){var t;console.log(e);console.log(e.results);i.setData(e.results);n.getView().setModel(i,"Timesheet");c.close()}.bind(this),error:function(e){console.log(e);c.close()}.bind(this)})},onUpdateFinished:function(){var e=this.getView().byId("daysTable");var t=e.getItems();for(var a=0;a<t.length;a++){if(t[a].getCells()[17].getText()==="60"){t[a].getMultiSelectControl(true).setEditable(false)}else{t[a].getMultiSelectControl(true).setEditable(true)}}},onSelectionChange:function(e){var t=e.getSource();var a=t.getSelectedItems();var s=a.length;var i=this.getView().byId("id_button_cancel");var n=false;if(s>0){try{i.setEnabled(true);a.forEach(function(e,t){var a=e.getCells()[17].getText();if(a==="60"){n=true;throw"Already deleted"}})}catch(e){i.setEnabled(false)}}else{i.setEnabled(false)}},onAdd:function(e){var t=this;v=this.byId("id_dialogaddentries");k=new sap.ui.model.json.JSONModel;for(b=0;b<=4;b++){var a={};a.Id=b;a.TimesheetDate="";a.TaskType="";a.WBSElemt="";a.RecordedHours="0";a.RecordedQuantity="0";_.push(a)}k.setData(_);t.getView().setModel(k,"Entries");k.refresh(true);if(!v){v=new sap.ui.xmlfragment(this.getView().getId(),"timesheetentry.view.AddTimesheetEntries",this);this.getView().addDependent(v);v.open();var s=this.getView().byId("id_add_employee_extid");var i=this.getView().byId("id_add_wrkid");var n=this.getView().byId("id_add_ccode");s.setText(this.getView().byId("id_employee_extid").getText());i.setText(this.getView().byId("id_wrkid_add").getText());De="";ye="";if(de){n.setSelectedKey(de)}if(ge){n.setValue(ge)}}else{v.open();var s=this.getView().byId("id_add_employee_extid");var i=this.getView().byId("id_add_wrkid");var n=this.getView().byId("id_add_ccode");s.setText(this.getView().byId("id_employee_extid").getText());i.setText(this.getView().byId("id_wrkid_add").getText());if(de){n.setSelectedKey(de)}if(ge){n.setValue(ge)}}},onAddEntry:function(e){var t=this;var a={};b=b+1;a.Id=b;a.TimesheetDate="";a.TaskType="";a.WBSElemt="";a.RecordedHours="0";a.RecordedQuantity="0";_.push(a);k.setData(_);t.getView().setModel(k,"Entries");k.refresh(true)},deleteRow:function(e){var t;t=this;var a=e.getParameter("listItem");var s=a.getCells();var i=s[0].getValue();var n=i*1;const r=_.findIndex(e=>e.Id===n);if(r!==-1){_.splice(r,1);k.setData(_);t.getView().setModel(k,"Entries");k.refresh(true)}var l=this.getView().byId("tableId1");l.removeItem(e.getParameter("listItem"))},onCloseDialog:function(){var e;e=this;_=[];M=0;k.setData(_);e.getView().setModel(k,"Entries");k.refresh(true);sap.ui.getCore().getMessageManager().removeAllMessages();this.getView().byId("id_dialogaddentries").close();this.getView().byId("id_add_entrysave").setEnabled(false);this.getView().byId("id_add_entry_submit").setEnabled(false);this.getView().byId("id_add_entrytemplate").setEnabled(false);this.getView().byId("id_templatecombo").setSelectedKey("")},handleDateChangeadd_entries:function(e){var t=this.getView().byId("id_add_entrysave");var a=this.getView().byId("id_add_entry_submit");var s=this.getView().byId("id_add_entrytemplate");var i=this;var n=[],r=e.getParameter("from"),l=e.getParameter("to"),o=e.getParameter("value"),d=e.getParameter("valid"),g=e.getSource();if(d){g.setValueState(he.None);n=o.split("â€“");if(n.length>1){x=n[0].trim();W=n[1].trim();var m=this._datediff(r,l);if(m>6){g.setValueState(he.Error);g.setValueStateText("Date Range should be with in 7 days");t.setEnabled(false);a.setEnabled(false);s.setEnabled(true)}else{if(m===6){var u=new Date(x);var h=u.getDay();var p=new Date(W);var p=p.getDay();if(h!==6&&p!==5){g.setValueState(he.Error);g.setValueStateText("Date Range should start Week Days(Saturday - Friday)");t.setEnabled(false);a.setEnabled(false);s.setEnabled(true)}}else if(m<=5){var u=new Date(x);var h=u.getDay();if(h===6){K=new sap.ui.model.json.JSONModel({start:u,end:new Date(new Date(u).getTime()+5184e5)});K.refresh();i.getView().setModel(K,"DateModel1")}else if(h===5){K=new sap.ui.model.json.JSONModel({start:new Date(new Date(u).getTime()-5184e5),end:u});K.refresh();i.getView().setModel(K,"DateModel1")}else if(h===4){K=new sap.ui.model.json.JSONModel({start:new Date(new Date(u).getTime()-432e6),end:new Date(new Date(u).getTime()+864e5)});K.refresh();i.getView().setModel(K,"DateModel1")}else if(h===3){K=new sap.ui.model.json.JSONModel({start:new Date(new Date(u).getTime()-3456e5),end:new Date(new Date(u).getTime()+1728e5)});K.refresh();i.getView().setModel(K,"DateModel1")}else if(h===2){K=new sap.ui.model.json.JSONModel({start:new Date(new Date(u).getTime()-2592e5),end:new Date(new Date(u).getTime()+2592e5)});K.refresh();i.getView().setModel(K,"DateModel1")}else if(h===1){K=new sap.ui.model.json.JSONModel({start:new Date(new Date(u).getTime()-1728e5),end:new Date(new Date(u).getTime()+3456e5)});K.refresh();i.getView().setModel(K,"DateModel1")}else if(h===0){K=new sap.ui.model.json.JSONModel({start:new Date(new Date(u).getTime()-864e5),end:new Date(new Date(u).getTime()+432e6)});K.refresh();i.getView().setModel(K,"DateModel1")}var i=this;k=new sap.ui.model.json.JSONModel;_=[];for(b=0;b<=4;b++){var c={};c.Id=b;c.TimesheetDate="";c.TaskType="";c.WBSElemt="";c.RecordedHours="0";c.RecordedQuantity="0";_.push(c)}k.setData(_);i.getView().setModel(k,"Entries");k.refresh(true)}else{g.setValueState(he.None);g.setValueStateText("");t.setEnabled(false);a.setEnabled(false);s.setEnabled(false);var i=this;k=new sap.ui.model.json.JSONModel;_=[];for(b=0;b<=4;b++){var c={};c.Id=b;c.TimesheetDate="";c.TaskType="";c.WBSElemt="";c.RecordedHours="0";c.RecordedQuantity="0";_.push(c)}k.setData(_);i.getView().setModel(k,"Entries");k.refresh(true)}}}else{x=n[0].trim();W=n[0].trim();var u=new Date(x);var h=u.getDay();if(h===6){K=new sap.ui.model.json.JSONModel({start:u,end:new Date(new Date(u).getTime()+5184e5)});K.refresh();i.getView().setModel(K,"DateModel1")}else if(h===5){K=new sap.ui.model.json.JSONModel({start:new Date(new Date(u).getTime()-5184e5),end:u});K.refresh();i.getView().setModel(K,"DateModel1")}else if(h===4){K=new sap.ui.model.json.JSONModel({start:new Date(new Date(u).getTime()-432e6),end:new Date(new Date(u).getTime()+864e5)});K.refresh();i.getView().setModel(K,"DateModel1")}else if(h===3){K=new sap.ui.model.json.JSONModel({start:new Date(new Date(u).getTime()-3456e5),end:new Date(new Date(u).getTime()+1728e5)});K.refresh();i.getView().setModel(K,"DateModel1")}else if(h===2){K=new sap.ui.model.json.JSONModel({start:new Date(new Date(u).getTime()-2592e5),end:new Date(new Date(u).getTime()+2592e5)});K.refresh();i.getView().setModel(K,"DateModel1")}else if(h===1){K=new sap.ui.model.json.JSONModel({start:new Date(new Date(u).getTime()-1728e5),end:new Date(new Date(u).getTime()+3456e5)});K.refresh();i.getView().setModel(K,"DateModel1")}else if(h===0){K=new sap.ui.model.json.JSONModel({start:new Date(new Date(u).getTime()-864e5),end:new Date(new Date(u).getTime()+432e6)});K.refresh();i.getView().setModel(K,"DateModel1")}t.setEnabled(true);a.setEnabled(true);var i=this;k=new sap.ui.model.json.JSONModel;_=[];for(b=0;b<=4;b++){var c={};c.Id=b;c.TimesheetDate="";c.TaskType="";c.WBSElemt="";c.RecordedHours="0";c.RecordedQuantity="0";_.push(c)}k.setData(_);i.getView().setModel(k,"Entries");k.refresh(true)}}else{g.setValueState(he.Error);g.setValueStateText("Invalid Date");t.setEnabled(false);a.setEnabled(false)}},adddatechange:function(e){var t=e.getSource();var a=t.getValue();var s=new Date(a);var i=this.getView().byId("id_add_entrysave");var n=this.getView().byId("id_add_entry_submit");var r=this.getView().byId("id_add_entrytemplate");var l=sap.ui.core.format.DateFormat.getDateInstance({pattern:"yyyy-MM-dd"});var o=this.getView().getModel("DateModel1").getProperty("/");var d=l.format(o.start);var g=l.format(o.end);var m=l.format(s);if(m>=d&&m<=g){t.setValueState(he.None);t.setValueStateText("");i.setEnabled(true);n.setEnabled(true);r.setEnabled(true)}else{t.setValueState(he.Error);t.setValueStateText("Date should be in the selected Time Period");i.setEnabled(false);n.setEnabled(false);r.setEnabled(false)}},taskChange:function(e){var t=this.getView().byId("id_add_entrysave");var a=this.getView().byId("id_add_entry_submit");var s=this.getView().byId("id_add_entrytemplate");var i=e.getSource(),n=i.getSelectedKey(),r=i.getValue();if(!n&&r){i.setValueState(he.Error);i.setValueStateText("Please enter a valid Task Type");t.setEnabled(false);a.setEnabled(false);s.setEnabled(false)}else{i.setValueState(he.None);t.setEnabled(true);a.setEnabled(true);s.setEnabled(true)}},wbsChange:function(e){var t=this.getView().byId("id_add_entrysave");var a=this.getView().byId("id_add_entry_submit");var s=this.getView().byId("id_add_entrytemplate");var i=e.getSource(),n=i.getSelectedKey(),r=i.getValue();if(!n&&r){i.setValueState(he.Error);i.setValueStateText("Please enter a valid WBS Element");t.setEnabled(false);a.setEnabled(false);s.setEnabled(false)}else{i.setValueState(he.None);t.setEnabled(true);a.setEnabled(true);s.setEnabled(true)}},getWbsElement:function(e,t){var a=[];var s=this;var i,n,r;var l,o;var d=new Date(t);l=d.getFullYear();o=d.getMonth()+1;var g=o.toString();var m=g.padStart(3,"0");H=this.getOwnerComponent().getModel("WbsElementService");U=new sap.ui.model.json.JSONModel;i=new sap.ui.model.Filter("PersonExternalID","EQ",e);a.push(i);n=new sap.ui.model.Filter("FiscalYear","EQ",l);a.push(n);r=new sap.ui.model.Filter("FiscalPeriod","EQ",m);a.push(r);q=new sap.m.BusyDialog({title:"Loading Data",text:"Please wait....."});q.open();H.read("/MyWbsElement",{filters:a,urlParameters:{$top:999999},success:function(e){if(e.results.length!==0){U.setData(e.results);s.getView().setModel(U,"ResourceWbs");s._setwbsDialog()}else{y.warning("No Wbs Element Data Found. Please try with another Date..");q.close()}}.bind(this),error:function(e){q.close()}.bind(this)})},getWbsElementAll:function(){var e=this;O=this.getOwnerComponent().getModel("WbsElementServiceAll");z=new sap.ui.model.json.JSONModel;q=new sap.m.BusyDialog({title:"Loading Data",text:"Please wait....."});q.open();O.read("/MyWbsElementAll",{urlParameters:{$top:999999},success:function(t){if(t.results.length!==0){z.setData(t.results);e.getView().setModel(z,"ResourceWbsAll");e._setwbsAllDialog()}else{y.warning("No Wbs Element Data Found.");q.close()}}.bind(this),error:function(e){q.close()}.bind(this)})},onAddWbsVH:function(e){ie=e.getSource();var t;var a=e.getSource().getParent().getCells()[1].getValue();var s=this.getView().byId("id_employee_extid").getText();if(C.oData.configFile[0].WbsElementEmployee===true){t=true}else{t=false}console.log(C);if(ve){this.getWbsElementAll()}else{this.getWbsElement(s,a)}},_setwbsDialog:function(){this._oBasicSearchFieldWithSuggestionsWbs=new d;this.pDialogWithSuggestionsWbs=this.loadFragment({name:"timesheetentry.view.WbsVH"}).then(function(e){var t=e.getFilterBar(),a,s,i,n,l,o,d,m,p,c,w;this._oVHDWithSuggestionsWbs=e;this.getView().addDependent(e);e.setRangeKeyFields([{label:"Engagement Project",key:"EngagementProject",type:"string",typeInstance:new h({},{maxLength:20})}]);t.setFilterBarExpanded(false);t.setBasicSearch(this._oBasicSearchFieldWithSuggestionsWbs);this._oBasicSearchFieldWithSuggestionsWbs.attachSearch(function(){t.search()});e.getTableAsync().then(function(t){if(t.bindRows){t.bindAggregation("rows",{path:"ResourceWbs>/",events:{dataReceived:function(){e.update()}}});a=new g({label:new u({text:"Engagement Project"}),template:new r({wrapping:false,text:"{ResourceWbs>EngagementProject}"})});a.data({fieldName:"EngagementProject"});t.addColumn(a);s=new g({label:new u({text:"Engagement Project Name"}),template:new r({wrapping:false,text:"{ResourceWbs>EngagementProjectName}"})});s.data({fieldName:"EngagementProjectName"});t.addColumn(s);i=new g({label:new u({text:"Work Package"}),template:new r({wrapping:false,text:"{ResourceWbs>WorkPackage}"})});i.data({fieldName:"WorkPackage"});t.addColumn(i);n=new g({label:new u({text:"Work Package Name"}),template:new r({wrapping:false,text:"{ResourceWbs>WorkPackageName}"})});n.data({fieldName:"WorkPackageName"});t.addColumn(n);l=new g({label:new u({text:"Work Package InternalId"}),template:new r({wrapping:false,text:"{ResourceWbs>WBSElementInternalID}"})});l.data({fieldName:"WBSElementInternalID"});t.addColumn(l);o=new g({label:new u({text:"Project Resource Type"}),template:new r({wrapping:false,text:"{ResourceWbs>EngagementProjectResourceType}"})});o.data({fieldName:"EngagementProjectResourceType"});t.addColumn(o);d=new g({label:new u({text:"Project Resource Text"}),template:new r({wrapping:false,text:"{ResourceWbs>EngagementProjResourceTypeText}"})});d.data({fieldName:"EngagementProjResourceTypeText"});t.addColumn(d);m=new g({label:new u({text:"Project Resource"}),template:new r({wrapping:false,text:"{ResourceWbs>EngagementProjectResource}"})});m.data({fieldName:"EngagementProjectResource"});t.addColumn(m);p=new g({label:new u({text:"Project Resource Text"}),template:new r({wrapping:false,text:"{ResourceWbs>EngagementProjResourceText}"})});p.data({fieldName:"EngagementProjResourceText"});t.addColumn(p);c=new g({label:new u({text:"Startdate"}),template:new r({wrapping:false,text:"{ResourceWbs>WorkPackageStartDate}"})});c.data({fieldName:"WorkPackageStartDate"});t.addColumn(c);w=new g({label:new u({text:"Enddate"}),template:new r({wrapping:false,text:"{ResourceWbs>WorkPackageEndDate}"})});w.data({fieldName:"WorkPackageEndDate"});t.addColumn(w)}}.bind(this));e.open();q.close()}.bind(this))},onValueHelpWbsVHOkPress:function(e){var t=this.getView().byId("id_add_entrysave");var a=this.getView().byId("id_add_entry_submit");var s=this.getView().byId("id_add_entrytemplate");var i=e.getParameter("tokens");if(i.length>0){var n=i[0].getKey();var r=i[0].getAggregation("customData");var l=r[0].getProperty("value");ie.setValue(l.WorkPackage+"-"+l.EngagementProjectResource);ie.setValueState(he.None);ie.setValueStateText("");t.setEnabled(true);a.setEnabled(true);s.setEnabled(true)}this._oVHDWithSuggestionsWbs.close()},onValueHelpWbsVHCancelPress:function(e){this._oVHDWithSuggestionsWbs.close()},onValueHelpWbsVHAfterClose:function(e){this._oVHDWithSuggestionsWbs.destroy()},onFilterBarWithSuggestionsWbsVHSearch:function(e){var t=this._oBasicSearchFieldWithSuggestionsWbs.getValue(),a=e.getParameter("selectionSet"),s=a.reduce(function(e,t){if(t.getValue()){e.push(new o({path:t.getName(),operator:c.Contains,value1:t.getValue()}))}return e},[]);s.push(new o({filters:[new o({path:"EngagementProject",operator:c.Contains,value1:t})],and:false}));this._filterTableWithSuggestionsWbs(new o({filters:s,and:true}))},_filterTableWithSuggestionsWbs:function(e){var t=this._oVHDWithSuggestionsWbs;t.getTableAsync().then(function(a){if(a.bindRows){a.getBinding("rows").filter(e)}if(a.bindItems){a.getBinding("items").filter(e)}t.update()})},_setwbsAllDialog:function(){this._oBasicSearchFieldWithSuggestionsWbsAll=new d;this.pDialogWithSuggestionsWbsAll=this.loadFragment({name:"timesheetentry.view.WbsAllVH"}).then(function(e){var t=e.getFilterBar(),a,s,i,n,l,o,d,m,p,c,w;this._oVHDWithSuggestionsWbsAll=e;this.getView().addDependent(e);e.setRangeKeyFields([{label:"Project External Id",key:"ProjectExternalID",type:"string",typeInstance:new h({},{maxLength:20})}]);t.setFilterBarExpanded(false);t.setBasicSearch(this._oBasicSearchFieldWithSuggestionsWbsAll);this._oBasicSearchFieldWithSuggestionsWbsAll.attachSearch(function(){t.search()});e.getTableAsync().then(function(t){if(t.bindRows){t.bindAggregation("rows",{path:"ResourceWbsAll>/",events:{dataReceived:function(){e.update()}}});a=new g({label:new u({text:"Project External"}),template:new r({wrapping:false,text:"{ResourceWbsAll>ProjectExternalID}"})});a.data({fieldName:"ProjectExternalID"});t.addColumn(a);s=new g({label:new u({text:"Project Description"}),template:new r({wrapping:false,text:"{ResourceWbsAll>ProjectDescription}"})});s.data({fieldName:"ProjectDescription"});t.addColumn(s);l=new g({label:new u({text:"Work Package InternalId"}),template:new r({wrapping:false,text:"{ResourceWbsAll>WBSElementInternalID}"})});l.data({fieldName:"WBSElementInternalID"});t.addColumn(l);c=new g({label:new u({text:"Startdate"}),template:new r({wrapping:false,text:"{ResourceWbsAll>PlannedStartDate}"})});c.data({fieldName:"PlannedStartDate"});t.addColumn(c);w=new g({label:new u({text:"Enddate"}),template:new r({wrapping:false,text:"{ResourceWbsAll>PlannedEndDate}"})});w.data({fieldName:"PlannedEndDate"});t.addColumn(w)}}.bind(this));e.open();q.close()}.bind(this))},onValueHelpWbsAllVHOkPress:function(e){var t=this.getView().byId("id_add_entrysave");var a=this.getView().byId("id_add_entry_submit");var s=this.getView().byId("id_add_entrytemplate");var i=e.getParameter("tokens");if(i.length>0){var n=i[0].getKey();var r=i[0].getAggregation("customData");var l=r[0].getProperty("value");ie.setValue(l.WBSElementInternalID);ie.setValueState(he.None);ie.setValueStateText("");t.setEnabled(true);a.setEnabled(true);s.setEnabled(true)}this._oVHDWithSuggestionsWbsAll.close()},onValueHelpWbsAllVHCancelPress:function(e){this._oVHDWithSuggestionsWbsAll.close()},onValueHelpWbsAllVHAfterClose:function(e){this._oVHDWithSuggestionsWbsAll.destroy()},onFilterBarWithSuggestionsWbsAllVHSearch:function(e){var t=this._oBasicSearchFieldWithSuggestionsWbs.getValue(),a=e.getParameter("selectionSet"),s=a.reduce(function(e,t){if(t.getValue()){e.push(new o({path:t.getName(),operator:c.Contains,value1:t.getValue()}))}return e},[]);s.push(new o({filters:[new o({path:"ProjectExternalID",operator:c.Contains,value1:t})],and:false}));this._filterTableWithSuggestionsWbsAll(new o({filters:s,and:true}))},_filterTableWithSuggestionsWbsAll:function(e){var t=this._oVHDWithSuggestionsWbsAll;t.getTableAsync().then(function(a){if(a.bindRows){a.getBinding("rows").filter(e)}if(a.bindItems){a.getBinding("items").filter(e)}t.update()})},_entriesValidations:function(e){var t=this.byId("id_add_employee_extid");var a=this.byId("id_add_wrkid");var s=this.byId("id_add_ccode");var i;var n=s.getSelectedKey();var r=t.getText();var l=a.getText();i=false;if(n==""||n==null){i=true}if(r==""||r==null){i=true}if(l==""||l==null){i=true}if(i===false){for(let t=0;t<e.length;t++){if(i===false){if((e[t].TimesheetDate==null||e[t].TimesheetDate=="")&&(e[t].RecordedHours==null||e[t].RecordedHours==""||e[t].RecordedHours=="0")&&(e[t].TaskType==null&&e[t].WBSElemt==null||e[t].TaskType==""&&e[t].WBSElemt=="")){i=false}else{if(e[t].TimesheetDate==null||e[t].TimesheetDate==""){i=true}if(e[t].RecordedHours==null||e[t].RecordedHours==""){i=true}if(e[t].TaskType==null||e[t].TaskType==""){if(e[t].WBSElemt==null||e[t].WBSElemt==""){i=true}}}}}}return i},onsubmitDialog:async function(){var e;e=this;var t=e.getView();X=new sap.m.BusyDialog({title:"Saving",text:"Please wait....."});X.open();var a=[];var s=[];var i=this.byId("id_alert");var n=sap.ui.getCore().getMessageManager();t.setModel(n.getMessageModel(),"message");sap.ui.getCore().getMessageManager().removeAllMessages();var r=this.byId("id_add_employee_extid");var l=this.byId("id_add_wrkid");var o=this.byId("id_add_ccode");var d=this.byId("id_add_ccenter");var g=this.getView().byId("tableId1");var m=g.getBinding("items");a=m.oList;var u=this.getOwnerComponent().getModel();var h=sap.ui.core.format.DateFormat.getDateInstance({pattern:"yyyy-MM-dd"});var p=this._entriesValidations(a);if(p===false){for(let t=0;t<a.length;t++){if((a[t].TimesheetDate==null||a[t].TimesheetDate=="")&&(a[t].RecordedHours==null||a[t].RecordedHours==""||a[t].RecordedHours=="0")&&(a[t].TaskType==null&&a[t].WBSElemt==null||a[t].TaskType==""&&a[t].WBSElemt=="")){continue}else{var c={};var w=[];M=M+1;c.PersonWorkAgreementExternalID=r.getText();c.PersonWorkAgreement=re;var T=h.format(a[t].TimesheetDate);c.TimeSheetDate=T+"T00:00:00";c.TimeSheetStatus="30";c.TimeSheetOperation="C";c.CompanyCode=this.getView().byId("id_add_ccode").getSelectedKey();c.TimeSheetIsExecutedInTestRun=false;c.TimeSheetIsReleasedOnSave=true;c.TimeSheetDataFields_RecordedHours=a[t].RecordedHours;c.TimeSheetDataFields_RecordedQuantity=a[t].RecordedHours;if(a[t].WBSElemt){w=a[t].WBSElemt.split("-");c.TimeSheetDataFields_WBSElement=w[0];c.TimeSheetDataFields_ActivityType=w[1]}c.TimeSheetDataFields_TimeSheetTaskType=a[t].TaskType;c.TimeSheetDataFields_ReceiverPubSecFuncnlArea="YB40";c.TimeSheetDataFields_HoursUnitOfMeasure="H";if(a[t].TaskType){c.TimeSheetDataFields_TimeSheetTaskComponent="WORK";c.TimeSheetDataFields_TimeSheetTaskLevel="NONE"}else{c.TimeSheetDataFields_TimeSheetTaskComponent="";c.TimeSheetDataFields_TimeSheetTaskLevel=""}s[t]=c;try{let a=await e._postEntries(A,s[t],t,M)}catch(e){continue}}}ce.setData(V);e.getView().setModel(ce,"CreateMessageData");ce.refresh(true);e._logmessage()}else{var D=new f({message:"Fill all the details- Employee External Id,Person Worker Agreement ID,Company Code,Task Type/WBS Element, Recorded Hours",type:Y.Error,target:"/Dummy",processor:this.getView().getModel()});i.setIcon("sap-icon://error");i.setType("Reject");sap.ui.getCore().getMessageManager().addMessages(D);X.close()}},_postEntries:function(e,t,a,s){return new Promise((a,s)=>{e.create("/MyTimesheet",t,{success:function(e,s){I=I+1;if(s.statusCode=="201"){var i={};i.Status="S";i.RecordedHours=t.TimeSheetDataFields_RecordedHours;i.Taskid=t.TimeSheetDataFields_TimeSheetTaskType;i.Wbselement=t.TimeSheetDataFields_WBSElement;i.TimeSheetDate=t.TimeSheetDate;i.Message='Entry successfully created on "'+t.TimeSheetDate+'", with a duration of "'+t.TimeSheetDataFields_RecordedHours+'" hours. ';V.push(i);a(e)}}.bind(this),error:function(e){I=I+1;var a=JSON.parse(e.responseText);var i={};i.Status="E";i.RecordedHours=t.TimeSheetDataFields_RecordedHours;i.Taskid=t.TimeSheetDataFields_TimeSheetTaskType;i.Wbselement=t.TimeSheetDataFields_WBSElement;i.TimeSheetDate=t.TimeSheetDate;i.Message=a.error.message.value;V.push(i);s(e)}.bind(this)})})},_logmessage:function(){ue=this.byId("dialogmessageboxcreate");if(!ue){ue=new sap.ui.xmlfragment(this.getView().getId(),"timesheetentry.view.MessageBox",this);this.getView().addDependent(ue);ue.open()}else{ue.open()}},onmessageboxCloseDialog:function(){var e=this;sap.ui.getCore().getMessageManager().removeAllMessages();I=0;M=0;V=[];ce.setData(V);this.getView().setModel(ce,"CreateMessageData");ce.refresh(true);_=[];k.setData(_);e.getView().setModel(k,"Entries");k.refresh(true);this.byId("dialogmessageboxcreate").close();X.close();this.getView().byId("id_dialogaddentries").close()},ondeleterow:function(e){var t=new sap.m.BusyDialog({title:"Processing Deletion of Record",text:"Please wait....."});t.open();var a=sap.ui.core.format.DateFormat.getDateInstance({pattern:"yyyy-MM-dd"});var s={};var l=this.getOwnerComponent().getModel("TimesheetDeleteService");var o=this.getView().byId("id_employee_extid");var d=e.getSource().getParent();var g=d.getCells();var m=o.getText();var u=re;var h=g[0].getValue();var p=g[9].getText();var c=g[12].getText();var w=g[10].getText();var f=g[13].getText();var T=g[11].getText();var D=g[5].getText();var y=g[5].getText();var v=g[14].getText();var b=g[15].getText();var _=g[16].getText();s.PersonWorkAgreementExternalID=m;s.PersonWorkAgreement=u;var S=new Date(h);var V=a.format(S);s.TimeSheetDate=V+"T00:00:00";s.TimeSheetRecord=p;s.CompanyCode=b;s.TimeSheetOperation="D";s.TimeSheetIsReleasedOnSave=true;s.TimeSheetIsExecutedInTestRun=false;s.TimeSheetDataFields_TimeSheetTaskType=c;s.TimeSheetDataFields_TimeSheetTaskComponent=w;s.TimeSheetDataFields_TimeSheetTaskLevel=f;s.TimeSheetDataFields_ReceiverCostCenter=T;s.TimeSheetDataFields_RecordedHours=D;s.TimeSheetDataFields_RecordedQuantity=y;s.TimeSheetDataFields_ControllingArea=v;s.TimeSheetDataFields_WBSElement=_;s.TimeSheetDataFields_HoursUnitOfMeasure="H";l.create("/MyTimesheetDelete",s,{success:function(e,a){if(a.statusCode=="201"){this.oLogMessageDeleteDialog=new i({type:Z.Message,title:"Information",state:he.Information,content:new r({text:'"'+p+'"'+" "+"Record deleted Successfully."}),beginButton:new n({type:$.Emphasized,text:"Ok",press:function(){this.oLogMessageDeleteDialog.close();t.close();this._bindtimesheet(m,x,W)}.bind(this)})});this.oLogMessageDeleteDialog.open()}}.bind(this),error:function(e){var a=JSON.parse(e.responseText);this.oLogMessageDeleteDialogerror=new i({type:Z.Message,title:"Information",state:he.Information,content:new r({text:'"'+a.error.message.value+'"'}),beginButton:new n({type:$.Emphasized,text:"Ok",press:function(){this.oLogMessageDeleteDialogerror.close();t.close()}.bind(this)})});this.oLogMessageDeleteDialogerror.open()}.bind(this)})},ondelete:async function(e){ee=new sap.m.BusyDialog({title:"Processing Deletion of Records",text:"Please wait....."});ee.open();var t=this.getOwnerComponent().getModel("TimesheetDeleteService");var a=[];var s=this;var i=sap.ui.core.format.DateFormat.getDateInstance({pattern:"yyyy-MM-dd"});var n=this.getView().byId("id_employee_extid");var r=this.getView().byId("daysTable");var l=r.getSelectedItems();if(l){for(var o=0;o<l.length;o++){var d={};var g=l[o].getCells();d.PersonWorkAgreementExternalID=n.getText();d.PersonWorkAgreement=re;var m=new Date(g[0].getValue());var u=i.format(m);d.TimeSheetDate=u+"T00:00:00";d.TimeSheetRecord=g[9].getText();d.CompanyCode=g[15].getText();d.TimeSheetOperation="D";d.TimeSheetIsReleasedOnSave=true;d.TimeSheetIsExecutedInTestRun=false;d.TimeSheetDataFields_TimeSheetTaskType=g[12].getText();d.TimeSheetDataFields_TimeSheetTaskComponent=g[10].getText();d.TimeSheetDataFields_TimeSheetTaskLevel=g[13].getText();d.TimeSheetDataFields_ReceiverCostCenter=g[11].getText();d.TimeSheetDataFields_RecordedHours=g[5].getText();d.TimeSheetDataFields_RecordedQuantity=g[5].getText();d.TimeSheetDataFields_ControllingArea=g[14].getText();d.TimeSheetDataFields_WBSElement=g[16].getText();d.TimeSheetDataFields_HoursUnitOfMeasure="H";a[o]=d;let e=await s._deleteallrecords(t,a[o])}s._logmessageError()}},_deleteallrecords:function(e,t){return new Promise((a,s)=>{e.create("/MyTimesheetDelete",t,{success:function(e,t){if(t.statusCode=="201"){a(t)}}.bind(this),error:function(e){var t=JSON.parse(e.responseText);s(t)}.bind(this)})})},_logmessageError:function(){var e=this;var t=this.getView().byId("id_employee_extid");var a=t.getText();this.oLogMessagedeleteAllDialog=new i({type:Z.Message,title:"Information",state:he.Information,content:new r({text:"Entries Processed for Deletion"}),beginButton:new n({type:$.Emphasized,text:"Ok",press:function(){E=0;this.oLogMessagedeleteAllDialog.close();ee.close();e._bindtimesheet(a,x,W)}.bind(this)})});this.oLogMessagedeleteAllDialog.open()},onsaveDialog:async function(e){var t;t=this;var a=t.getView();X=new sap.m.BusyDialog({title:"Saving",text:"Please wait....."});X.open();var s=[];var i=[];var n=this.byId("id_alert");var r=sap.ui.getCore().getMessageManager();a.setModel(r.getMessageModel(),"message");sap.ui.getCore().getMessageManager().removeAllMessages();var l=this.byId("id_add_employee_extid");var o=this.byId("id_add_wrkid");var d=this.byId("id_add_ccode");var g=this.byId("id_add_ccenter");var m=this.getView().byId("tableId1");var u=m.getBinding("items");s=u.oList;var h=sap.ui.core.format.DateFormat.getDateInstance({pattern:"yyyy-MM-dd"});var p=this._entriesValidations(s);if(p===false){for(let e=0;e<s.length;e++){if((s[e].TimesheetDate==null||s[e].TimesheetDate=="")&&(s[e].RecordedHours==null||s[e].RecordedHours==""||s[e].RecordedHours=="0")&&(s[e].TaskType==null&&s[e].WBSElemt==null||s[e].TaskType==""&&s[e].WBSElemt=="")){continue}else{var c={};var w=[];c.PersonWorkAgreementExternalID=l.getText();c.PersonWorkAgreement=re;var T=h.format(s[e].TimesheetDate);c.TimeSheetDate=T+"T00:00:00";c.TimeSheetStatus="10";c.TimeSheetOperation="C";c.CompanyCode=this.getView().byId("id_add_ccode").getSelectedKey();c.TimeSheetIsExecutedInTestRun=false;c.TimeSheetIsReleasedOnSave=false;c.TimeSheetDataFields_RecordedHours=s[e].RecordedHours;c.TimeSheetDataFields_RecordedQuantity=s[e].RecordedHours;if(s[e].WBSElemt){w=s[e].WBSElemt.split("-");c.TimeSheetDataFields_WBSElement=w[0];c.TimeSheetDataFields_ActivityType=w[1]}c.TimeSheetDataFields_TimeSheetTaskType=s[e].TaskType;c.TimeSheetDataFields_ReceiverPubSecFuncnlArea="YB40";c.TimeSheetDataFields_HoursUnitOfMeasure="H";if(s[e].TaskType){c.TimeSheetDataFields_TimeSheetTaskComponent="WORK";c.TimeSheetDataFields_TimeSheetTaskLevel="NONE"}else{c.TimeSheetDataFields_TimeSheetTaskComponent="";c.TimeSheetDataFields_TimeSheetTaskLevel=""}i[e]=c;try{let a=await t._postEntries(A,i[e],e,M)}catch(e){continue}}}ce.setData(V);t.getView().setModel(ce,"CreateMessageData");ce.refresh(true);t._logmessage()}else{var D=new f({message:"Fill all the details- Employee External Id,Person Worker Agreement ID,Company Code,Task Type/WBS Element, Recorded Hours",type:Y.Error,target:"/Dummy",processor:this.getView().getModel()});n.setIcon("sap-icon://error");n.setType("Reject");sap.ui.getCore().getMessageManager().addMessages(D);X.close()}},downloadButton:function(){var e,t,a,s,i;if(!this._oTable){this._oTable=this.byId("iddialogmessageboxTable")}i=this._oTable;t=i.getBinding("items");e=this._createColumnConfig();a={workbook:{columns:e,hierarchyLevel:"Level"},dataSource:t,fileName:"Timesheet Entry logs.xlsx"};s=new D(a);s.build().finally(function(){s.destroy()})},_createColumnConfig:function(){var e=[];e.push({label:"Status",type:pe.String,property:"Status"});e.push({label:"Recorded Hours",property:"TimeSheetDate",type:pe.String});e.push({label:"Task Id",property:"Taskid",type:pe.String});e.push({label:"WBS Element",property:"Wbselement",type:pe.String});e.push({label:"Recorded Hours",property:"RecordedHours",type:pe.Number,scale:5});e.push({label:"Message",property:"Message",type:pe.String});return e},onMessagePopoverPress:function(e){var t=e.getSource();this._getMessagePopover().then(function(e){e.openBy(t)})},_getMessagePopover:function(){var e=this.getView();if(!this._pMessagePopover){this._pMessagePopover=w.load({id:e.getId(),name:"timesheetentry.view.MessageManager"}).then(function(t){e.addDependent(t);return t})}return this._pMessagePopover},onupdatesubmit:async function(){ee=new sap.m.BusyDialog({title:"Processing Submission of Records",text:"Please wait....."});ee.open();var e=this.getOwnerComponent().getModel();e.setUseBatch(true);var t=[];var a=this;var s=sap.ui.core.format.DateFormat.getDateInstance({pattern:"yyyy-MM-dd"});var i=this.getView().byId("id_employee_extid");var n=this.getView().byId("id_wrkid_add");var r=this.getView().byId("daysTable");var l=r.getSelectedItems();if(l){for(var o=0;o<l.length;o++){var d={};var g=l[o].getCells();d.PersonWorkAgreementExternalID=i.getText();d.PersonWorkAgreement=re;var m=new Date(g[0].getValue());var u=s.format(m);d.TimeSheetDate=u+"T00:00:00";d.TimeSheetRecord=g[9].getText();d.CompanyCode=g[15].getText();d.TimeSheetOperation="U";d.TimeSheetStatus="30";d.TimeSheetIsReleasedOnSave=true;d.TimeSheetIsExecutedInTestRun=false;d.TimeSheetDataFields_TimeSheetTaskType=g[12].getText();d.TimeSheetDataFields_TimeSheetTaskComponent=g[10].getText();d.TimeSheetDataFields_TimeSheetTaskLevel=g[13].getText();d.TimeSheetDataFields_ReceiverCostCenter=g[11].getText();d.TimeSheetDataFields_RecordedHours=g[5].getText();d.TimeSheetDataFields_RecordedQuantity=g[5].getText();d.TimeSheetDataFields_ControllingArea=g[14].getText();d.TimeSheetDataFields_WBSElement=g[16].getText();d.TimeSheetDataFields_HoursUnitOfMeasure="H";t[o]=d;try{let s=await a._deleteallrecords(e,t[o])}catch(e){continue}}a._logmessageError()}},templateChange:async function(e){var t=e.getSource(),a=t.getSelectedKey(),s=[],i=this,n=this.byId("id_add_employee_extid").getText(),r=this.getOwnerComponent().getModel("TimesheetPreviousService"),l=this.getOwnerComponent().getModel("SavetemplateService"),o=new sap.ui.model.Filter("PersonWorkAgreementExternalID","EQ",n);s.push(o);if(a=="1"){De="";ye="";te=new sap.m.BusyDialog({title:"loading Previous Timecard",text:"Please wait....."});te.open();var d=new Date((new Date).getTime()-6048e5);i._getdates(d);if(fe&&Te){var g=fe+"T00:00:00Z";var m=Te+"T23:59:59Z";var u=new sap.ui.model.Filter("TimeSheetDate","BT",g,m);s.push(u)}let e=await i._getpreviousdata(r,s);if(e.length>0){var h=sap.ui.core.format.DateFormat.getDateInstance({pattern:"yyyy-MM-dd"});var p=this.getView().getModel("DateModel1").getProperty("/");var c=h.format(p.start);var f=new Date(c);k=new sap.ui.model.json.JSONModel;i._getdates(f);let t=i._getDateRange(fe,Te);if(t){console.log(t);_=[];for(b=0;b<e.length;b++){console.log(new Date(e[b].TimeSheetDate));let a=t.filter(function(t){return t.Day===new Date(e[b].TimeSheetDate).getDay()});console.log(a[0].Date);var T={};T.Id=b;T.TimesheetDate=a[0].Date;T.TaskType=e[b].TimeSheetTaskType;T.WBSElemt="";T.RecordedHours=e[b].RecordedHours;T.RecordedQuantity=e[b].RecordedHours;_.push(T)}_.sort(function(e,t){var a=new Date(e.TimesheetDate);var s=new Date(t.TimesheetDate);return a-s});k.setData(_);i.getView().setModel(k,"Entries");k.refresh(true);te.close();this.getView().byId("id_add_entrysave").setEnabled(true);this.getView().byId("id_add_entry_submit").setEnabled(true);this.getView().byId("id_add_entrytemplate").setEnabled(true)}}}else if(a=="2"){ae=new sap.m.BusyDialog({title:"Loading Data",text:"Please wait....."});ae.open();var D=this.getView().byId("id_employee_extid").getText(),y=this.getView();let e=await i._getTemplates(l,D);if(e){we.setData(e);we.refresh();i.getView().setModel(we,"AllTemplates");if(!this._pValueHelpDialog){this._pValueHelpDialog=w.load({id:y.getId(),name:"timesheetentry.view.GetTemplates",controller:this}).then(function(e){y.addDependent(e);return e})}this._pValueHelpDialog.then(function(e){ae.close();e.open()})}else{we.setData(e);we.refresh();i.getView().setModel(we,"AllTemplates");if(!this._pValueHelpDialog){this._pValueHelpDialog=w.load({id:y.getId(),name:"timesheetentry.view.GetTemplates",controller:this}).then(function(e){y.addDependent(e);return e})}this._pValueHelpDialog.then(function(e){ae.close();e.open()})}this.getView().byId("id_add_entrysave").setEnabled(true);this.getView().byId("id_add_entry_submit").setEnabled(true);this.getView().byId("id_add_entrytemplate").setEnabled(true)}else{var i=this;k=new sap.ui.model.json.JSONModel;_=[];for(b=0;b<=4;b++){var T={};T.Id=b;T.TimesheetDate="";T.TaskType="";T.WBSElemt="";T.RecordedHours="0";T.RecordedQuantity="0";_.push(T)}k.setData(_);i.getView().setModel(k,"Entries");k.refresh(true);this.getView().byId("id_add_entrysave").setEnabled(false);this.getView().byId("id_add_entry_submit").setEnabled(false)}},_getpreviousdata:async function(e,t){return new Promise((a,s)=>{e.read("/MyTimesheetPreviousDetails",{filters:t,urlParameters:{$top:999999},success:function(e){console.log(e.results);a(e.results)}.bind(this),error:function(e){console.log(e)}.bind(this)})})},_getdates:function(e){var t=new Date(e);var a=t.getDay();var s,i;var n=sap.ui.core.format.DateFormat.getDateInstance({pattern:"yyyy-MM-dd"});if(a===6){s=t;i=new Date(new Date(t).getTime()+5184e5);fe=n.format(s);Te=n.format(i)}else if(a===5){s=new Date(new Date(t).getTime()-5184e5);i=t;fe=n.format(s);Te=n.format(i)}else if(a===4){s=new Date(new Date(t).getTime()-432e6);i=new Date(new Date(t).getTime()+864e5);fe=n.format(s);Te=n.format(i)}else if(a===3){s=new Date(new Date(t).getTime()-3456e5);i=new Date(new Date(t).getTime()+1728e5);fe=n.format(s);Te=n.format(i)}else if(a===2){s=new Date(new Date(t).getTime()-2592e5);i=new Date(new Date(t).getTime()+2592e5);fe=n.format(s);Te=n.format(i)}else if(a===1){s=new Date(new Date(t).getTime()-1728e5);i=new Date(new Date(t).getTime()+3456e5);fe=n.format(s);Te=n.format(i)}else if(a===0){s=new Date(new Date(t).getTime()-864e5);i=new Date(new Date(t).getTime()+432e6);fe=n.format(s);Te=n.format(i)}},_getDateRange:function(e,t){var a=0,s=[],i;var n={};n.Date=new Date(e);n.Day=new Date(e).getDay();s.push(n);do{let t={};if(a==0){i=new Date(new Date(e).getTime()+864e5)}else{i=new Date(i.getTime()+864e5)}t.Date=i;t.Day=i.getDay();s.push(t);a++}while(a<5);var n={};n.Date=new Date(t);n.Day=new Date(t).getDay();s.push(n);return s},ontemplateDialog:async function(){var e=this.byId("id_dialogtemplateentries");if(!e){e=new sap.ui.xmlfragment(this.getView().getId(),"timesheetentry.view.SaveTemplate",this);this.getView().addDependent(e);if(De){this.getView().byId("id_templateid_save").setValue(De);this.getView().byId("id_templateid_save").setEditable(false);this.getView().byId("id_template_submit").setVisible(false);this.getView().byId("id_template_update").setVisible(true)}else{this.getView().byId("id_templateid_save").setValue("");this.getView().byId("id_templateid_save").setEditable(true);this.getView().byId("id_template_submit").setVisible(true);this.getView().byId("id_template_update").setVisible(false)}if(ye){this.getView().byId("id_templatedesc_save").setValue(ye)}else{this.getView().byId("id_templatedesc_save").setValue("")}e.open()}else{if(De){this.getView().byId("id_templateid_save").setValue(De);this.getView().byId("id_templateid_save").setEditable(false);this.getView().byId("id_template_submit").setVisible(false);this.getView().byId("id_template_update").setVisible(true)}else{this.getView().byId("id_templateid_save").setValue("");this.getView().byId("id_templateid_save").setEditable(true);this.getView().byId("id_template_submit").setVisible(true);this.getView().byId("id_template_update").setVisible(false)}if(ye){this.getView().byId("id_templatedesc_save").setValue(ye)}else{this.getView().byId("id_templatedesc_save").setValue("")}e.open()}},_saveTemplate:function(e,t){return new Promise((a,s)=>{e.create("/SaveTemplate",{entries:t},{success:function(e,t){if(t.statusCode=="200"){a(t)}else{a(t)}}.bind(this),error:function(e){var t=JSON.parse(e.responseText);s(t)}.bind(this)})})},_updateTemplate:function(e,t){return new Promise((a,s)=>{e.create("/UpdateTemplate",{entries:t},{success:function(e,t){if(t.statusCode=="200"){a(t)}else{a(t)}}.bind(this),error:function(e){var t=JSON.parse(e.responseText);s(t)}.bind(this)})})},_getTemplates:function(e,t){return new Promise((a,s)=>{e.callFunction("/GetTemplates",{method:"GET",urlParameters:{EmployeeExternalId:t},success:function(e){var t=e.results;console.log(t);if(t.length>0){a(t)}else{a(t)}},error:function(e){s(e)}})})},ongettemplateSearch:function(e){var t=e.getParameter("value");var a=new o("TemplateDescription",c.Contains,t);var s=e.getParameter("itemsBinding");s.filter([a])},ongettemplateClose:async function(e){var t=this.getOwnerComponent().getModel("SavetemplateService"),a=this,s=sap.ui.core.format.DateFormat.getDateInstance({pattern:"yyyy-MM-dd"}),i=this.getView().getModel("DateModel1").getProperty("/"),n=s.format(i.start),r=new Date(n),l=e.getSource(),o=l.getCells()[0].getTitle();De=l.getCells()[0].getTitle();ye=l.getCells()[1].getText();var d=new sap.m.BusyDialog({title:"Loading Data",text:"Please wait....."});d.open();if(l){var g=l.getCells()[0].getTitle();var m=await a._getTemplate(t,g);if(m.length>0){k=new sap.ui.model.json.JSONModel;a._getdates(r);let e=a._getDateRange(fe,Te);_=[];for(b=0;b<m.length;b++){console.log(new Date(m[b].Date));let t=e.filter(function(e){return e.Day===m[b].Day});console.log(t[0].Date);var u={};u.Id=b;u.TimesheetDate=t[0].Date;u.TaskType=m[b].TaskType;u.WBSElemt=m[b].WBSElement;u.RecordedHours=m[b].RecordedHours;u.RecordedQuantity=m[b].RecordedHours;_.push(u)}_.sort(function(e,t){var a=new Date(e.TimesheetDate);var s=new Date(t.TimesheetDate);return a-s});k.setData(_);a.getView().setModel(k,"Entries");k.refresh(true);this.getView().byId("id_add_entrysave").setEnabled(true);this.getView().byId("id_add_entry_submit").setEnabled(true);this.getView().byId("id_add_entrytemplate").setEnabled(true);d.close();this.getView().byId("id_dialogtemplateentrieslist").close()}else{d.close();this.getView().byId("id_dialogtemplateentrieslist").close()}}else{d.close();this.getView().byId("id_dialogtemplateentrieslist").close()}},_getTemplate:function(e,t){return new Promise((a,s)=>{e.callFunction("/GetTemplate",{method:"GET",urlParameters:{TemplateId:t},success:function(e){var t=e.results;console.log(t);if(t.length>0){a(t)}else{a(t)}},error:function(e){s(e)}})})},ontemplatesaveDialog:async function(){var e;e=this;var t=e.getView();j=this.getOwnerComponent().getModel("SavetemplateService");X=new sap.m.BusyDialog({title:"Saving Template",text:"Please wait....."});X.open();var a=[];var s=[];var i=this.byId("id_alert");var n=sap.ui.getCore().getMessageManager();t.setModel(n.getMessageModel(),"message");sap.ui.getCore().getMessageManager().removeAllMessages();var r=this.byId("id_add_employee_extid");var l=this.getView().byId("id_templateid_save");var o=this.getView().byId("id_templatedesc_save");var d=this.getView().byId("tableId1");var g=d.getBinding("items");a=g.oList;var m=sap.ui.core.format.DateFormat.getDateInstance({pattern:"yyyy-MM-dd"});var u=this._entriesValidations(a);if(u===false){for(let e=0;e<a.length;e++){if((a[e].TimesheetDate==null||a[e].TimesheetDate=="")&&(a[e].RecordedHours==null||a[e].RecordedHours==""||a[e].RecordedHours=="0")&&(a[e].TaskType==null&&a[e].WBSElemt==null||a[e].TaskType==""&&a[e].WBSElemt=="")){continue}else{var h={};h.EmployeeExternalId=r.getText();h.TemplateId=l.getValue();h.TemplateDescription=o.getValue();var p=m.format(a[e].TimesheetDate);h.Date=p;h.RecordedHours=a[e].RecordedHours;h.WBSElement=a[e].WBSElemt;h.TaskType=a[e].TaskType;h.Day=new Date(p).getDay();s.push(h)}}let t=await e._saveTemplate(j,s);if(t){e._logmessageTemplate(t)}}else{var c=new f({message:"Fill all the details- Employee External Id,Person Worker Agreement ID,Company Code,Task Type/WBS Element, Recorded Hours",type:Y.Error,target:"/Dummy",processor:this.getView().getModel()});i.setIcon("sap-icon://error");i.setType("Reject");sap.ui.getCore().getMessageManager().addMessages(c);X.close()}},ontemplateupdateDialog:async function(){var e;e=this;var t=e.getView();j=this.getOwnerComponent().getModel("SavetemplateService");X=new sap.m.BusyDialog({title:"Updating Template",text:"Please wait....."});X.open();var a=[];var s=[];var i=this.byId("id_alert");var n=sap.ui.getCore().getMessageManager();t.setModel(n.getMessageModel(),"message");sap.ui.getCore().getMessageManager().removeAllMessages();var r=this.byId("id_add_employee_extid");var l=this.getView().byId("id_templateid_save");var o=this.getView().byId("id_templatedesc_save");var d=this.getView().byId("tableId1");var g=d.getBinding("items");a=g.oList;var m=sap.ui.core.format.DateFormat.getDateInstance({pattern:"yyyy-MM-dd"});var u=this._entriesValidations(a);if(u===false){for(let e=0;e<a.length;e++){if((a[e].TimesheetDate==null||a[e].TimesheetDate=="")&&(a[e].RecordedHours==null||a[e].RecordedHours==""||a[e].RecordedHours=="0")&&(a[e].TaskType==null&&a[e].WBSElemt==null||a[e].TaskType==""&&a[e].WBSElemt=="")){continue}else{var h={};h.EmployeeExternalId=r.getText();h.TemplateId=l.getValue();h.TemplateDescription=o.getValue();var p=m.format(a[e].TimesheetDate);h.Date=p;h.RecordedHours=a[e].RecordedHours;h.WBSElement=a[e].WBSElemt;h.TaskType=a[e].TaskType;h.Day=new Date(p).getDay();s.push(h)}}let t=await e._updateTemplate(j,s);if(t){e._logmessageTemplate(t)}}else{var c=new f({message:"Fill all the details- Employee External Id,Person Worker Agreement ID,Company Code,Task Type/WBS Element, Recorded Hours",type:Y.Error,target:"/Dummy",processor:this.getView().getModel()});i.setIcon("sap-icon://error");i.setType("Reject");sap.ui.getCore().getMessageManager().addMessages(c);X.close()}},onCloseDialogtemplate:function(){this.getView().byId("id_dialogtemplateentries").close();this.getView().byId("id_templateid_save").setValue("");this.getView().byId("id_templatedesc_save").setValue("")},_logmessageTemplate:function(e){var t=this;var a,s;var l=this.getView().byId("id_templateid_save");var o=l.getValue();if(e.statusCode=="200"){a="Template-"+" "+o+" "+"Saved Successfully";s=he.Information}else{a="Template-"+" "+o+" "+"failed to save";s=he.Error}this.oLogMessageTemplateDialog=new i({type:Z.Message,title:"Information",state:s,content:new r({text:a}),beginButton:new n({type:$.Emphasized,text:"Ok",press:function(){this.oLogMessageTemplateDialog.close();_=[];M=0;k.setData(_);t.getView().setModel(k,"Entries");k.refresh(true);sap.ui.getCore().getMessageManager().removeAllMessages();this.getView().byId("id_dialogaddentries").close();this.getView().byId("id_add_entrysave").setEnabled(false);this.getView().byId("id_add_entry_submit").setEnabled(false);this.getView().byId("id_add_entrytemplate").setEnabled(false);this.getView().byId("id_templatecombo").setSelectedKey("");this.getView().byId("id_dialogtemplateentries").close();this.getView().byId("id_templateid_save").setValue("");this.getView().byId("id_templatedesc_save").setValue("");X.close()}.bind(this)})});this.oLogMessageTemplateDialog.open()},deletetemplate:async function(e){se=new sap.m.BusyDialog({title:"Delete Template",text:"Please wait....."});se.open();var t=this.getView().byId("id_add_employee_extid"),a=e.getParameter("listItem"),s=a.getCells(),i=s[0].getTitle(),n=this.getOwnerComponent().getModel("SavetemplateService"),r=this;var l=[],o={};if(i){o.TemplateId=i;o.EmployeeExternalId=t.getText();l.push(o);let e=await r._deleteTemplate(n,l);if(e){let a=await r._getTemplates(n,t.getText());if(a){we.setData(a);we.refresh();r.getView().setModel(we,"AllTemplates")}r._logmessageDeleteTemplate(e)}}else{se.close()}},_deleteTemplate:async function(e,t){return new Promise((a,s)=>{e.create("/DeleteTemplate",{entries:t},{success:function(e,s){if(s.statusCode=="200"){a({Id:t[0].TemplateId,message:"Template Success deleted",status:"200"})}else{a({Id:t[0].TemplateId,message:"Template Success deleted",status:"200"})}}.bind(this),error:function(e){var a=JSON.parse(e.responseText);s({Id:t[0].TemplateId,message:a,status:"500"})}.bind(this)})})},_logmessageDeleteTemplate:async function(e){var t=this;var a,s;var l=e.Id;if(e.status=="200"){a="Template-"+" "+l+" "+"Deleted Successfully";s=he.Information}else{a="Template-"+" "+l+" "+"failed to delete";s=he.Error}this.oLogMessageTemplatedeleteDialog=new i({type:Z.Message,title:"Information",state:s,content:new r({text:a}),beginButton:new n({type:$.Emphasized,text:"Ok",press:function e(){this.oLogMessageTemplatedeleteDialog.close();se.close()}.bind(this)})});this.oLogMessageTemplatedeleteDialog.open()},ontemplateclose:function(){this.getView().byId("id_dialogtemplateentrieslist").close();this.getView().byId("id_templatecombo").setSelectedKey("")},onfieldSetting:function(){var e=this.byId("id_dialogsettings");if(!e){e=new sap.ui.xmlfragment(this.getView().getId(),"timesheetentry.view.Settings",this);this.getView().addDependent(e);e.open()}else{e.open()}},onsettingok:function(){var e=this.getView().byId("tablesetting");var t=e.getBinding("items"),a=t.oList;if(a[1].Checked==true&&a[2].Checked==true){y.error("Both Employee Wbs Element and Wbs Element cannot be checked!!")}else{if(a[0].Checked==true){F=this.getView().getModel("FieldProperty");F.setProperty("/bHideColumn",true)}else{F=this.getView().getModel("FieldProperty");F.setProperty("/bHideColumn",false);F.refresh()}if(a[1].Checked==true){ve=""}else if(a[2].Checked==true){ve="X"}else{ve="X"}this.getView().byId("id_dialogsettings").close()}},onsettingClose:function(){this.getView().byId("id_dialogsettings").close()}})});
//# sourceMappingURL=timesheet_view.controller.js.map