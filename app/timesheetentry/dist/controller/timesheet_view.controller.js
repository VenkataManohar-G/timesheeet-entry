sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/core/library","sap/ui/export/library","sap/m/library","sap/m/Dialog","sap/m/Button","sap/m/Text","sap/ui/model/Sorter","sap/ui/model/Filter","sap/m/SearchField","sap/ui/table/Column","sap/m/Column","sap/m/Label","sap/ui/model/type/String","sap/ui/comp/library","sap/ui/model/FilterOperator","sap/ui/core/Fragment","sap/ui/core/message/Message","sap/ushell/Container","sap/ui/export/Spreadsheet","sap/m/MessageBox"],(e,t,a,s,i,r,n,o,l,d,g,m,u,h,c,w,T,D,p,f,v)=>{"use strict";var y,S,b=[],_=[],M=0,x=0,E=0,V,I,k;var C,W,R,P,F,O,N,B,H,j,A,J;var L=t.MessageType,Q=s.DialogType,K=s.ButtonType;var U,z,Y,Z,$,q,G,X,ee,te,ae,se,ie;var re=t.ValueState,ne=a.EdmType;var oe=new sap.ui.model.json.JSONModel;var le,de;return e.extend("timesheetentry.controller.timesheet_view",{formatWbsElement:function(e){var t,a;if(e){t=e.toString();a=t.padStart(8,"0");return a}},formatStatus:function(e){if(e==="30"){return"Success"}else if(e==="10"){return"Information"}else{return"Error"}},shellDetails:function(){var e;if(sap.ushell&&sap.ushell.Container){var t=sap.ushell.Container.getService("UserInfo");if(t){e=t.getEmail();if(!e){e="rkirlampudi@answerthink.com"}}else{e="rkirlampudi@answerthink.com"}}else{e="rkirlampudi@answerthink.com"}return e},UserDetails:async function(e){ee=await this.shellDetails();if(ee){this._getuserdetails(ee)}},_getuserdetails:function(e){var t=[];var a,s,o;o=new sap.ui.model.Filter("Email","EQ",e);e;t.push(o);var l=new sap.m.BusyDialog({title:"Loading Data",text:"Please wait....."});l.open();R=this.getOwnerComponent().getModel("EmployeeService");R.read("/MyEmployeeData",{filters:t,urlParameters:{$top:999999},success:function(e){var t={};var a=this.getView().byId("id_employee_extid");var s=this.getView().byId("id_wrkid_add");var o=this.getView().byId("id_ccenter_add");var d=this.getView().byId("id_search");var g,m;B=new sap.ui.model.json.JSONModel;var u=this;if(e.results.length!==0){t=e.results;if(t.length!==0){B.setData(e.results);u.getView().setModel(B,"CompanyCodes");a.setText(t[0].PersonWorkAgreementExternalID);G=t[0].PersonWorkAgreement;if(t[0].PersonFullName){g=t[0].PersonWorkAgreement+" ("+t[0].PersonFullName+")";s.setText(g);s.setVisible(true)}else{g=t[0].PersonWorkAgreement;s.setText(g);s.setVisible(true)}if(t[0].CostCenterDescription){m=t[0].CostCenter+" ("+t[0].CostCenterDescription+")";o.setText(m);o.setVisible(true)}else{m=t[0].CostCenter;o.setText(m);o.setVisible(true)}if(t.length===1){te=t[0].CompanyCode;ae=t[0].CompanyCodeName}d.setEnabled(true)}else{this.oReadSuccessMessageDialog=new i({type:Q.Message,title:"Information",state:re.Warning,content:new n({text:"No Data Found with the Selected Company Code!!..Please try with another"}),beginButton:new r({type:K.Emphasized,text:"Ok",press:function(){s.setText("");a.setText("");o.setText("");d.setEnabled(false);this.oReadSuccessMessageDialog.close()}.bind(this)})});this.oReadSuccessMessageDialog.open()}}else{this.oReadSuccessMessageDialog=new i({type:Q.Message,title:"Information",state:re.Warning,content:new n({text:"No Employee Found"}),beginButton:new r({type:K.Emphasized,text:"Ok",press:function(){s.setText("");a.setText("");o.setText("");d.setEnabled(false);this.oReadSuccessMessageDialog.close()}.bind(this)})});this.oReadSuccessMessageDialog.open()}l.close()}.bind(this),error:function(e){this.oReadErrorMessageDialog=new i({type:Q.Message,title:"Error",state:re.Error,content:new n({text:""+e+""}),beginButton:new r({type:K.Emphasized,text:"Ok",press:function(){this.oReadErrorMessageDialog.close()}.bind(this)})});this.oReadErrorMessageDialog.open();l.close()}.bind(this)})},onInit(){var e=this;this.UserDetails();C=this.getOwnerComponent().getModel();F=this.getOwnerComponent().getModel("TaskTypeService");O=this.getOwnerComponent().getModel("TimesheetService");e.getView().setModel(F,"Tasks");H=this.getOwnerComponent().getModel("TemplateJSONData");e.getView().setModel(H,"Template");j=new sap.ui.model.json.JSONModel({start:"",end:""});e.getView().setModel(j,"DateModel");k=this.getOwnerComponent().getModel("configurationModel");this.dateTimePeriod()},dateTimePeriod:function(){var e=new Date;var t=e.getDay();var a=this;if(t===6){var s=new Date(new Date(e).getTime()+5184e5);A=new sap.ui.model.json.JSONModel({start:e,end:new Date(new Date(e).getTime()+5184e5)});A.refresh();a.getView().setModel(A,"DateModel1")}else if(t===5){A=new sap.ui.model.json.JSONModel({start:new Date(new Date(e).getTime()-5184e5),end:e});A.refresh();a.getView().setModel(A,"DateModel1")}else if(t===4){A=new sap.ui.model.json.JSONModel({start:new Date(new Date(e).getTime()-432e6),end:new Date(new Date(e).getTime()+864e5)});A.refresh();a.getView().setModel(A,"DateModel1")}else if(t===3){A=new sap.ui.model.json.JSONModel({start:new Date(new Date(e).getTime()-3456e5),end:new Date(new Date(e).getTime()+1728e5)});A.refresh();a.getView().setModel(A,"DateModel1")}else if(t===2){A=new sap.ui.model.json.JSONModel({start:new Date(new Date(e).getTime()-2592e5),end:new Date(new Date(e).getTime()+2592e5)});A.refresh();a.getView().setModel(A,"DateModel1")}else if(t===1){A=new sap.ui.model.json.JSONModel({start:new Date(new Date(e).getTime()-1728e5),end:new Date(new Date(e).getTime()+3456e5)});A.refresh();a.getView().setModel(A,"DateModel1")}else if(t===0){A=new sap.ui.model.json.JSONModel({start:new Date(new Date(e).getTime()-864e5),end:new Date(new Date(e).getTime()+432e6)});A.refresh();a.getView().setModel(A,"DateModel1")}},_datediff:function(e,t){const a=1e3*60*60*24;const s=Date.UTC(e.getFullYear(),e.getMonth(),e.getDate());const i=Date.UTC(t.getFullYear(),t.getMonth(),t.getDate());return Math.floor((i-s)/a)},handleDateChange:function(e){var t=this.getView().byId("id_search");var a=[],s=e.getParameter("from"),i=e.getParameter("to"),r=e.getParameter("value"),n=e.getParameter("valid"),o=e.getSource();if(n){o.setValueState(re.None);a=r.split("â€“");if(a.length>1){V=a[0].trim();I=a[1].trim();var l=this._datediff(s,i);if(l>60){o.setValueState(re.Error);o.setValueStateText("Date Range shouldn't exceed more than 60 days");t.setEnabled(false)}else{o.setValueState(re.None);o.setValueStateText("");t.setEnabled(true)}}else{V=a[0].trim();I=a[0].trim();t.setEnabled(true)}}else{o.setValueState(re.Error);o.setValueStateText("Invalid Date");t.setEnabled(false)}},onFilter:function(e){var t=this.getView().byId("id_employee_extid");var a=t.getText();var s=V;var o=I;if(a===""||s===undefined||o===undefined||s===""||o===""){this.oFillMessageDialog=new i({type:Q.Message,title:"Error",state:re.Error,content:new n({text:"Employee Id & Date are Mandatory"}),beginButton:new r({type:K.Emphasized,text:"Ok",press:function(){this.oFillMessageDialog.close()}.bind(this)})});this.oFillMessageDialog.open()}else{this._bindtimesheet(a,s,o)}},_bindtimesheet:function(e,t,a){var s=[];var i,r,n,o,l,d,g;r=this;i=new sap.ui.model.json.JSONModel;o=new sap.ui.model.Filter("PersonWorkAgreementExternalID","EQ",e);s.push(o);if(t&&a){var m=t+"T00:00:00Z";var u=a+"T23:59:59Z";var h=new sap.ui.model.Filter("TimeSheetDate","BT",m,u);s.push(h)}else if(t){var c=t+"T00:00:00Z";var u=t+"T23:59:59Z";var h=new sap.ui.model.Filter("TimeSheetDate","BT",c,u);s.push(h)}var w=new sap.m.BusyDialog({title:"Loading Data",text:"Please wait....."});w.open();C.read("/MyTimesheetDetails",{filters:s,urlParameters:{$top:999999},success:function(e){var t;console.log(e);console.log(e.results);i.setData(e.results);r.getView().setModel(i,"Timesheet");w.close()}.bind(this),error:function(e){console.log(e);w.close()}.bind(this)})},onUpdateFinished:function(){var e=this.getView().byId("daysTable");var t=e.getItems();for(var a=0;a<t.length;a++){if(t[a].getCells()[17].getText()==="60"){t[a].getMultiSelectControl(true).setEditable(false)}else{t[a].getMultiSelectControl(true).setEditable(true)}}},onSelectionChange:function(e){var t=e.getSource();var a=t.getSelectedItems();var s=a.length;var i=this.getView().byId("id_button_cancel");var r=false;if(s>0){try{i.setEnabled(true);a.forEach(function(e,t){var a=e.getCells()[17].getText();if(a==="60"){r=true;throw"Already deleted"}})}catch(e){i.setEnabled(false)}}else{i.setEnabled(false)}},onAdd:function(e){var t=this;y=this.byId("id_dialogaddentries");W=new sap.ui.model.json.JSONModel;for(S=0;S<=4;S++){var a={};a.Id=S;a.TimesheetDate="";a.TaskType="";a.WBSElemt="";a.RecordedHours="0";a.RecordedQuantity="0";b.push(a)}W.setData(b);t.getView().setModel(W,"Entries");W.refresh(true);if(!y){y=new sap.ui.xmlfragment(this.getView().getId(),"timesheetentry.view.AddTimesheetEntries",this);this.getView().addDependent(y);y.open();var s=this.getView().byId("id_add_employee_extid");var i=this.getView().byId("id_add_wrkid");var r=this.getView().byId("id_add_ccode");s.setText(this.getView().byId("id_employee_extid").getText());i.setText(this.getView().byId("id_wrkid_add").getText());if(te){r.setSelectedKey(te)}if(ae){r.setValue(ae)}}else{y.open();var s=this.getView().byId("id_add_employee_extid");var i=this.getView().byId("id_add_wrkid");var r=this.getView().byId("id_add_ccode");s.setText(this.getView().byId("id_employee_extid").getText());i.setText(this.getView().byId("id_wrkid_add").getText());if(te){r.setSelectedKey(te)}if(ae){r.setValue(ae)}}},onAddEntry:function(e){var t=this;var a={};S=S+1;a.Id=S;a.TimesheetDate="";a.TaskType="";a.WBSElemt="";a.RecordedHours="0";a.RecordedQuantity="0";b.push(a);W.setData(b);t.getView().setModel(W,"Entries");W.refresh(true)},deleteRow:function(e){var t;t=this;var a=e.getParameter("listItem");var s=a.getCells();var i=s[0].getValue();var r=i*1;const n=b.findIndex(e=>e.Id===r);if(n!==-1){b.splice(n,1);W.setData(b);t.getView().setModel(W,"Entries");W.refresh(true)}var o=this.getView().byId("tableId1");o.removeItem(e.getParameter("listItem"))},onCloseDialog:function(){var e;e=this;b=[];M=0;W.setData(b);e.getView().setModel(W,"Entries");W.refresh(true);sap.ui.getCore().getMessageManager().removeAllMessages();this.getView().byId("id_dialogaddentries").close();this.getView().byId("id_add_entrysave").setEnabled(false);this.getView().byId("id_add_entry_submit").setEnabled(false);this.getView().byId("id_templatecombo").setSelectedKey("")},handleDateChangeadd_entries:function(e){var t=this.getView().byId("id_add_entrysave");var a=this.getView().byId("id_add_entry_submit");var s=this;var i=[],r=e.getParameter("from"),n=e.getParameter("to"),o=e.getParameter("value"),l=e.getParameter("valid"),d=e.getSource();if(l){d.setValueState(re.None);i=o.split("â€“");if(i.length>1){V=i[0].trim();I=i[1].trim();var g=this._datediff(r,n);if(g>6){d.setValueState(re.Error);d.setValueStateText("Date Range should be with in 7 days");t.setEnabled(false);a.setEnabled(false)}else{if(g===6){var m=new Date(V);var u=m.getDay();var h=new Date(I);var h=h.getDay();if(u!==6&&h!==5){d.setValueState(re.Error);d.setValueStateText("Date Range should start Week Days(Saturday - Friday)");t.setEnabled(false);a.setEnabled(false)}}else if(g<=5){var m=new Date(V);var u=m.getDay();if(u===6){A=new sap.ui.model.json.JSONModel({start:m,end:new Date(new Date(m).getTime()+5184e5)});A.refresh();s.getView().setModel(A,"DateModel1")}else if(u===5){A=new sap.ui.model.json.JSONModel({start:new Date(new Date(m).getTime()-5184e5),end:m});A.refresh();s.getView().setModel(A,"DateModel1")}else if(u===4){A=new sap.ui.model.json.JSONModel({start:new Date(new Date(m).getTime()-432e6),end:new Date(new Date(m).getTime()+864e5)});A.refresh();s.getView().setModel(A,"DateModel1")}else if(u===3){A=new sap.ui.model.json.JSONModel({start:new Date(new Date(m).getTime()-3456e5),end:new Date(new Date(m).getTime()+1728e5)});A.refresh();s.getView().setModel(A,"DateModel1")}else if(u===2){A=new sap.ui.model.json.JSONModel({start:new Date(new Date(m).getTime()-2592e5),end:new Date(new Date(m).getTime()+2592e5)});A.refresh();s.getView().setModel(A,"DateModel1")}else if(u===1){A=new sap.ui.model.json.JSONModel({start:new Date(new Date(m).getTime()-1728e5),end:new Date(new Date(m).getTime()+3456e5)});A.refresh();s.getView().setModel(A,"DateModel1")}else if(u===0){A=new sap.ui.model.json.JSONModel({start:new Date(new Date(m).getTime()-864e5),end:new Date(new Date(m).getTime()+432e6)});A.refresh();s.getView().setModel(A,"DateModel1")}}else{d.setValueState(re.None);d.setValueStateText("");t.setEnabled(false);a.setEnabled(false)}}}else{V=i[0].trim();I=i[0].trim();var m=new Date(V);var u=m.getDay();if(u===6){A=new sap.ui.model.json.JSONModel({start:m,end:new Date(new Date(m).getTime()+5184e5)});A.refresh();s.getView().setModel(A,"DateModel1")}else if(u===5){A=new sap.ui.model.json.JSONModel({start:new Date(new Date(m).getTime()-5184e5),end:m});A.refresh();s.getView().setModel(A,"DateModel1")}else if(u===4){A=new sap.ui.model.json.JSONModel({start:new Date(new Date(m).getTime()-432e6),end:new Date(new Date(m).getTime()+864e5)});A.refresh();s.getView().setModel(A,"DateModel1")}else if(u===3){A=new sap.ui.model.json.JSONModel({start:new Date(new Date(m).getTime()-3456e5),end:new Date(new Date(m).getTime()+1728e5)});A.refresh();s.getView().setModel(A,"DateModel1")}else if(u===2){A=new sap.ui.model.json.JSONModel({start:new Date(new Date(m).getTime()-2592e5),end:new Date(new Date(m).getTime()+2592e5)});A.refresh();s.getView().setModel(A,"DateModel1")}else if(u===1){A=new sap.ui.model.json.JSONModel({start:new Date(new Date(m).getTime()-1728e5),end:new Date(new Date(m).getTime()+3456e5)});A.refresh();s.getView().setModel(A,"DateModel1")}else if(u===0){A=new sap.ui.model.json.JSONModel({start:new Date(new Date(m).getTime()-864e5),end:new Date(new Date(m).getTime()+432e6)});A.refresh();s.getView().setModel(A,"DateModel1")}t.setEnabled(true);a.setEnabled(true)}}else{d.setValueState(re.Error);d.setValueStateText("Invalid Date");t.setEnabled(false);a.setEnabled(false)}},adddatechange:function(e){var t=e.getSource();var a=t.getValue();var s=new Date(a);var i=this.getView().byId("id_add_entrysave");var r=this.getView().byId("id_add_entry_submit");var n=sap.ui.core.format.DateFormat.getDateInstance({pattern:"yyyy-MM-dd"});var o=this.getView().getModel("DateModel1").getProperty("/");var l=n.format(o.start);var d=n.format(o.end);var g=n.format(s);if(g>=l&&g<=d){t.setValueState(re.None);t.setValueStateText("");i.setEnabled(true);r.setEnabled(true)}else{t.setValueState(re.Error);t.setValueStateText("Date should be in the selected Time Period");i.setEnabled(false);r.setEnabled(false)}},taskChange:function(e){var t=this.getView().byId("id_add_entrysave");var a=this.getView().byId("id_add_entry_submit");var s=e.getSource(),i=s.getSelectedKey(),r=s.getValue();if(!i&&r){s.setValueState(re.Error);s.setValueStateText("Please enter a valid Task Type");t.setEnabled(false);a.setEnabled(false)}else{s.setValueState(re.None);t.setEnabled(true);a.setEnabled(true)}},wbsChange:function(e){var t=this.getView().byId("id_add_entrysave");var a=this.getView().byId("id_add_entry_submit");var s=e.getSource(),i=s.getSelectedKey(),r=s.getValue();if(!i&&r){s.setValueState(re.Error);s.setValueStateText("Please enter a valid WBS Element");t.setEnabled(false);a.setEnabled(false)}else{s.setValueState(re.None);t.setEnabled(true);a.setEnabled(true)}},getWbsElement:function(e,t,a){var s=[];var i=this;var r,n,o;var l,d;var g=new Date(t);l=g.getFullYear();d=g.getMonth()+1;var m=d.toString();var u=m.padStart(3,"0");P=this.getOwnerComponent().getModel("WbsElementService");J=new sap.ui.model.json.JSONModel;if(a===true){r=new sap.ui.model.Filter("PersonExternalID","EQ",e);s.push(r)}n=new sap.ui.model.Filter("FiscalYear","EQ",l);s.push(n);o=new sap.ui.model.Filter("FiscalPeriod","EQ",u);s.push(o);z=new sap.m.BusyDialog({title:"Loading Data",text:"Please wait....."});z.open();P.read("/MyWbsElement",{filters:s,urlParameters:{$top:999999},success:function(e){if(e.results.length!==0){J.setData(e.results);i.getView().setModel(J,"ResourceWbs");i._setwbsDialog()}else{v.warning("No Wbs Element Data Found. Please try with another Date..");z.close()}}.bind(this),error:function(e){z.close()}.bind(this)})},onAddWbsVH:function(e){$=e.getSource();var t;var a=e.getSource().getParent().getCells()[1].getValue();var s=this.getView().byId("id_employee_extid").getText();if(k.oData.configFile[0].WbsElementEmployee===true){t=true}else{t=false}console.log(k);this.getWbsElement(s,a,t)},_setwbsDialog:function(){this._oBasicSearchFieldWithSuggestionsWbs=new d;this.pDialogWithSuggestionsWbs=this.loadFragment({name:"timesheetentry.view.WbsVH"}).then(function(e){var t=e.getFilterBar(),a,s,i,r,o,l,d,m,c,w,T;this._oVHDWithSuggestionsWbs=e;this.getView().addDependent(e);e.setRangeKeyFields([{label:"Engagement Project",key:"EngagementProject",type:"string",typeInstance:new h({},{maxLength:20})}]);t.setFilterBarExpanded(false);t.setBasicSearch(this._oBasicSearchFieldWithSuggestionsWbs);this._oBasicSearchFieldWithSuggestionsWbs.attachSearch(function(){t.search()});e.getTableAsync().then(function(t){if(t.bindRows){t.bindAggregation("rows",{path:"ResourceWbs>/",events:{dataReceived:function(){e.update()}}});a=new g({label:new u({text:"Engagement Project"}),template:new n({wrapping:false,text:"{ResourceWbs>EngagementProject}"})});a.data({fieldName:"EngagementProject"});t.addColumn(a);s=new g({label:new u({text:"Engagement Project Name"}),template:new n({wrapping:false,text:"{ResourceWbs>EngagementProjectName}"})});s.data({fieldName:"EngagementProjectName"});t.addColumn(s);i=new g({label:new u({text:"Work Package"}),template:new n({wrapping:false,text:"{ResourceWbs>WorkPackage}"})});i.data({fieldName:"WorkPackage"});t.addColumn(i);r=new g({label:new u({text:"Work Package Name"}),template:new n({wrapping:false,text:"{ResourceWbs>WorkPackageName}"})});r.data({fieldName:"WorkPackageName"});t.addColumn(r);o=new g({label:new u({text:"Work Package InternalId"}),template:new n({wrapping:false,text:"{ResourceWbs>WBSElementInternalID}"})});o.data({fieldName:"WBSElementInternalID"});t.addColumn(o);l=new g({label:new u({text:"Project Resource Type"}),template:new n({wrapping:false,text:"{ResourceWbs>EngagementProjectResourceType}"})});l.data({fieldName:"EngagementProjectResourceType"});t.addColumn(l);d=new g({label:new u({text:"Project Resource Text"}),template:new n({wrapping:false,text:"{ResourceWbs>EngagementProjResourceTypeText}"})});d.data({fieldName:"EngagementProjResourceTypeText"});t.addColumn(d);m=new g({label:new u({text:"Project Resource"}),template:new n({wrapping:false,text:"{ResourceWbs>EngagementProjectResource}"})});m.data({fieldName:"EngagementProjectResource"});t.addColumn(m);c=new g({label:new u({text:"Project Resource Text"}),template:new n({wrapping:false,text:"{ResourceWbs>EngagementProjResourceText}"})});c.data({fieldName:"EngagementProjResourceText"});t.addColumn(c);w=new g({label:new u({text:"Startdate"}),template:new n({wrapping:false,text:"{ResourceWbs>WorkPackageStartDate}"})});w.data({fieldName:"WorkPackageStartDate"});t.addColumn(w);T=new g({label:new u({text:"Enddate"}),template:new n({wrapping:false,text:"{ResourceWbs>WorkPackageEndDate}"})});T.data({fieldName:"WorkPackageEndDate"});t.addColumn(T)}}.bind(this));e.open();z.close()}.bind(this))},onValueHelpWbsVHOkPress:function(e){var t=this.getView().byId("id_add_entrysave");var a=this.getView().byId("id_add_entry_submit");var s=e.getParameter("tokens");if(s.length>0){var i=s[0].getKey();var r=s[0].getAggregation("customData");var n=r[0].getProperty("value");$.setValue(n.WorkPackage+"-"+n.EngagementProjectResource);$.setValueState(re.None);$.setValueStateText("");t.setEnabled(true);a.setEnabled(true)}this._oVHDWithSuggestionsWbs.close()},onValueHelpWbsVHCancelPress:function(e){this._oVHDWithSuggestionsWbs.close()},onValueHelpWbsVHAfterClose:function(e){this._oVHDWithSuggestionsWbs.destroy()},onFilterBarWithSuggestionsWbsVHSearch:function(e){var t=this._oBasicSearchFieldWithSuggestionsWbs.getValue(),a=e.getParameter("selectionSet"),s=a.reduce(function(e,t){if(t.getValue()){e.push(new l({path:t.getName(),operator:w.Contains,value1:t.getValue()}))}return e},[]);s.push(new l({filters:[new l({path:"EngagementProject",operator:w.Contains,value1:t})],and:false}));this._filterTableWithSuggestionsWbs(new l({filters:s,and:true}))},_filterTableWithSuggestionsWbs:function(e){var t=this._oVHDWithSuggestionsWbs;t.getTableAsync().then(function(a){if(a.bindRows){a.getBinding("rows").filter(e)}if(a.bindItems){a.getBinding("items").filter(e)}t.update()})},_entriesValidations:function(e){var t=this.byId("id_add_employee_extid");var a=this.byId("id_add_wrkid");var s=this.byId("id_add_ccode");var i;var r=s.getSelectedKey();var n=t.getText();var o=a.getText();i=false;if(r==""||r==null){i=true}if(n==""||n==null){i=true}if(o==""||o==null){i=true}if(i===false){for(let t=0;t<e.length;t++){if(i===false){if((e[t].TimesheetDate==null||e[t].TimesheetDate=="")&&(e[t].RecordedHours==null||e[t].RecordedHours==""||e[t].RecordedHours=="0")&&(e[t].TaskType==null&&e[t].WBSElemt==null||e[t].TaskType==""&&e[t].WBSElemt=="")){i=false}else{if(e[t].TimesheetDate==null||e[t].TimesheetDate==""){i=true}if(e[t].RecordedHours==null||e[t].RecordedHours==""){i=true}if(e[t].TaskType==null||e[t].TaskType==""){if(e[t].WBSElemt==null||e[t].WBSElemt==""){i=true}}}}}}return i},onsubmitDialog:async function(){var e;e=this;var t=e.getView();U=new sap.m.BusyDialog({title:"Saving",text:"Please wait....."});U.open();var a=[];var s=[];var i=this.byId("id_alert");var r=sap.ui.getCore().getMessageManager();t.setModel(r.getMessageModel(),"message");sap.ui.getCore().getMessageManager().removeAllMessages();var n=this.byId("id_add_employee_extid");var o=this.byId("id_add_wrkid");var l=this.byId("id_add_ccode");var d=this.byId("id_add_ccenter");var g=this.getView().byId("tableId1");var m=g.getBinding("items");a=m.oList;var u=this.getOwnerComponent().getModel();var h=sap.ui.core.format.DateFormat.getDateInstance({pattern:"yyyy-MM-dd"});var c=this._entriesValidations(a);if(c===false){for(let t=0;t<a.length;t++){if((a[t].TimesheetDate==null||a[t].TimesheetDate=="")&&(a[t].RecordedHours==null||a[t].RecordedHours==""||a[t].RecordedHours=="0")&&(a[t].TaskType==null&&a[t].WBSElemt==null||a[t].TaskType==""&&a[t].WBSElemt=="")){continue}else{var w={};var T=[];M=M+1;w.PersonWorkAgreementExternalID=n.getText();w.PersonWorkAgreement=G;var p=h.format(a[t].TimesheetDate);w.TimeSheetDate=p+"T00:00:00";w.TimeSheetStatus="30";w.TimeSheetOperation="C";w.CompanyCode=this.getView().byId("id_add_ccode").getSelectedKey();w.TimeSheetIsExecutedInTestRun=false;w.TimeSheetIsReleasedOnSave=true;w.TimeSheetDataFields_RecordedHours=a[t].RecordedHours;w.TimeSheetDataFields_RecordedQuantity=a[t].RecordedHours;if(a[t].WBSElemt){T=a[t].WBSElemt.split("-");w.TimeSheetDataFields_WBSElement=T[0];w.TimeSheetDataFields_ActivityType=T[1]}w.TimeSheetDataFields_TimeSheetTaskType=a[t].TaskType;w.TimeSheetDataFields_ReceiverPubSecFuncnlArea="YB40";w.TimeSheetDataFields_HoursUnitOfMeasure="H";if(a[t].TaskType){w.TimeSheetDataFields_TimeSheetTaskComponent="WORK";w.TimeSheetDataFields_TimeSheetTaskLevel="NONE"}else{w.TimeSheetDataFields_TimeSheetTaskComponent="";w.TimeSheetDataFields_TimeSheetTaskLevel=""}s[t]=w;let i=await e._postEntries(O,s[t],t,M)}}oe.setData(_);e.getView().setModel(oe,"CreateMessageData");oe.refresh(true);e._logmessage()}else{var f=new D({message:"Fill all the details- Employee External Id,Person Worker Agreement ID,Company Code,Task Type/WBS Element, Recorded Hours",type:L.Error,target:"/Dummy",processor:this.getView().getModel()});i.setIcon("sap-icon://error");i.setType("Reject");sap.ui.getCore().getMessageManager().addMessages(f);U.close()}},_postEntries:function(e,t,a,s){return new Promise((a,s)=>{e.create("/MyTimesheet",t,{success:function(e,s){x=x+1;if(s.statusCode=="201"){var i={};i.Status="S";i.RecordedHours=t.TimeSheetDataFields_RecordedHours;i.Taskid=t.TimeSheetDataFields_TimeSheetTaskType;i.Wbselement=t.TimeSheetDataFields_WBSElement;i.TimeSheetDate=t.TimeSheetDate;i.Message='Entry successfully created on "'+t.TimeSheetDate+'", with a duration of "'+t.TimeSheetDataFields_RecordedHours+'" hours. ';_.push(i);a(e)}}.bind(this),error:function(e){x=x+1;var a=JSON.parse(e.responseText);var i={};i.Status="E";i.RecordedHours=t.TimeSheetDataFields_RecordedHours;i.Taskid=t.TimeSheetDataFields_TimeSheetTaskType;i.Wbselement=t.TimeSheetDataFields_WBSElement;i.TimeSheetDate=t.TimeSheetDate;i.Message=a.error.message.value;_.push(i);s(e)}.bind(this)})})},_logmessage:function(){ie=this.byId("dialogmessageboxcreate");if(!ie){ie=new sap.ui.xmlfragment(this.getView().getId(),"timesheetentry.view.MessageBox",this);this.getView().addDependent(ie);ie.open()}else{ie.open()}},onmessageboxCloseDialog:function(){var e=this;sap.ui.getCore().getMessageManager().removeAllMessages();x=0;M=0;_=[];oe.setData(_);this.getView().setModel(oe,"CreateMessageData");oe.refresh(true);b=[];W.setData(b);e.getView().setModel(W,"Entries");W.refresh(true);this.byId("dialogmessageboxcreate").close();U.close();this.getView().byId("id_dialogaddentries").close()},ondeleterow:function(e){var t=new sap.m.BusyDialog({title:"Processing Deletion of Record",text:"Please wait....."});t.open();var a=sap.ui.core.format.DateFormat.getDateInstance({pattern:"yyyy-MM-dd"});var s={};var o=this.getOwnerComponent().getModel("TimesheetDeleteService");var l=this.getView().byId("id_employee_extid");var d=e.getSource().getParent();var g=d.getCells();var m=l.getText();var u=G;var h=g[0].getValue();var c=g[9].getText();var w=g[12].getText();var T=g[10].getText();var D=g[13].getText();var p=g[11].getText();var f=g[5].getText();var v=g[5].getText();var y=g[14].getText();var S=g[15].getText();var b=g[16].getText();s.PersonWorkAgreementExternalID=m;s.PersonWorkAgreement=u;var _=new Date(h);var M=a.format(_);s.TimeSheetDate=M+"T00:00:00";s.TimeSheetRecord=c;s.CompanyCode=S;s.TimeSheetOperation="D";s.TimeSheetIsReleasedOnSave=true;s.TimeSheetIsExecutedInTestRun=false;s.TimeSheetDataFields_TimeSheetTaskType=w;s.TimeSheetDataFields_TimeSheetTaskComponent=T;s.TimeSheetDataFields_TimeSheetTaskLevel=D;s.TimeSheetDataFields_ReceiverCostCenter=p;s.TimeSheetDataFields_RecordedHours=f;s.TimeSheetDataFields_RecordedQuantity=v;s.TimeSheetDataFields_ControllingArea=y;s.TimeSheetDataFields_WBSElement=b;s.TimeSheetDataFields_HoursUnitOfMeasure="H";o.create("/MyTimesheetDelete",s,{success:function(e,a){if(a.statusCode=="201"){this.oLogMessageDeleteDialog=new i({type:Q.Message,title:"Information",state:re.Information,content:new n({text:'"'+c+'"'+" "+"Record deleted Successfully."}),beginButton:new r({type:K.Emphasized,text:"Ok",press:function(){this.oLogMessageDeleteDialog.close();t.close();this._bindtimesheet(m,V,I)}.bind(this)})});this.oLogMessageDeleteDialog.open()}}.bind(this),error:function(e){var a=JSON.parse(e.responseText);this.oLogMessageDeleteDialogerror=new i({type:Q.Message,title:"Information",state:re.Information,content:new n({text:'"'+a.error.message.value+'"'}),beginButton:new r({type:K.Emphasized,text:"Ok",press:function(){this.oLogMessageDeleteDialogerror.close();t.close()}.bind(this)})});this.oLogMessageDeleteDialogerror.open()}.bind(this)})},ondelete:async function(e){Y=new sap.m.BusyDialog({title:"Processing Deletion of Records",text:"Please wait....."});Y.open();var t=this.getOwnerComponent().getModel("TimesheetDeleteService");var a=[];var s=this;var i=sap.ui.core.format.DateFormat.getDateInstance({pattern:"yyyy-MM-dd"});var r=this.getView().byId("id_employee_extid");var n=this.getView().byId("daysTable");var o=n.getSelectedItems();if(o){for(var l=0;l<o.length;l++){var d={};var g=o[l].getCells();d.PersonWorkAgreementExternalID=r.getText();d.PersonWorkAgreement=G;var m=new Date(g[0].getValue());var u=i.format(m);d.TimeSheetDate=u+"T00:00:00";d.TimeSheetRecord=g[9].getText();d.CompanyCode=g[15].getText();d.TimeSheetOperation="D";d.TimeSheetIsReleasedOnSave=true;d.TimeSheetIsExecutedInTestRun=false;d.TimeSheetDataFields_TimeSheetTaskType=g[12].getText();d.TimeSheetDataFields_TimeSheetTaskComponent=g[10].getText();d.TimeSheetDataFields_TimeSheetTaskLevel=g[13].getText();d.TimeSheetDataFields_ReceiverCostCenter=g[11].getText();d.TimeSheetDataFields_RecordedHours=g[5].getText();d.TimeSheetDataFields_RecordedQuantity=g[5].getText();d.TimeSheetDataFields_ControllingArea=g[14].getText();d.TimeSheetDataFields_WBSElement=g[16].getText();d.TimeSheetDataFields_HoursUnitOfMeasure="H";a[l]=d;let e=await s._deleteallrecords(t,a[l])}s._logmessageError()}},_deleteallrecords:function(e,t){return new Promise((a,s)=>{e.create("/MyTimesheetDelete",t,{success:function(e,t){if(t.statusCode=="201"){a(t)}}.bind(this),error:function(e){var t=JSON.parse(e.responseText);s(t)}.bind(this)})})},_logmessageError:function(){var e=this;var t=this.getView().byId("id_employee_extid");var a=t.getText();this.oLogMessagedeleteAllDialog=new i({type:Q.Message,title:"Information",state:re.Information,content:new n({text:"Entries Processed for Deletion"}),beginButton:new r({type:K.Emphasized,text:"Ok",press:function(){E=0;this.oLogMessagedeleteAllDialog.close();Y.close();e._bindtimesheet(a,V,I)}.bind(this)})});this.oLogMessagedeleteAllDialog.open()},onsaveDialog:async function(e){var t;t=this;var a=t.getView();U=new sap.m.BusyDialog({title:"Saving",text:"Please wait....."});U.open();var s=[];var i=[];var r=this.byId("id_alert");var n=sap.ui.getCore().getMessageManager();a.setModel(n.getMessageModel(),"message");sap.ui.getCore().getMessageManager().removeAllMessages();var o=this.byId("id_add_employee_extid");var l=this.byId("id_add_wrkid");var d=this.byId("id_add_ccode");var g=this.byId("id_add_ccenter");var m=this.getView().byId("tableId1");var u=m.getBinding("items");s=u.oList;var h=sap.ui.core.format.DateFormat.getDateInstance({pattern:"yyyy-MM-dd"});var c=this._entriesValidations(s);if(c===false){for(let e=0;e<s.length;e++){if((s[e].TimesheetDate==null||s[e].TimesheetDate=="")&&(s[e].RecordedHours==null||s[e].RecordedHours==""||s[e].RecordedHours=="0")&&(s[e].TaskType==null&&s[e].WBSElemt==null||s[e].TaskType==""&&s[e].WBSElemt=="")){continue}else{var w={};var T=[];w.PersonWorkAgreementExternalID=o.getText();w.PersonWorkAgreement=G;var p=h.format(s[e].TimesheetDate);w.TimeSheetDate=p+"T00:00:00";w.TimeSheetStatus="10";w.TimeSheetOperation="C";w.CompanyCode=this.getView().byId("id_add_ccode").getSelectedKey();w.TimeSheetIsExecutedInTestRun=false;w.TimeSheetIsReleasedOnSave=false;w.TimeSheetDataFields_RecordedHours=s[e].RecordedHours;w.TimeSheetDataFields_RecordedQuantity=s[e].RecordedHours;if(s[e].WBSElemt){T=s[e].WBSElemt.split("-");w.TimeSheetDataFields_WBSElement=T[0];w.TimeSheetDataFields_ActivityType=T[1]}w.TimeSheetDataFields_TimeSheetTaskType=s[e].TaskType;w.TimeSheetDataFields_ReceiverPubSecFuncnlArea="YB40";w.TimeSheetDataFields_HoursUnitOfMeasure="H";if(s[e].TaskType){w.TimeSheetDataFields_TimeSheetTaskComponent="WORK";w.TimeSheetDataFields_TimeSheetTaskLevel="NONE"}else{w.TimeSheetDataFields_TimeSheetTaskComponent="";w.TimeSheetDataFields_TimeSheetTaskLevel=""}i[e]=w;let a=await t._postEntries(O,i[e],e,M)}}oe.setData(_);t.getView().setModel(oe,"CreateMessageData");oe.refresh(true);t._logmessage()}else{var f=new D({message:"Fill all the details- Employee External Id,Person Worker Agreement ID,Company Code,Task Type/WBS Element, Recorded Hours",type:L.Error,target:"/Dummy",processor:this.getView().getModel()});r.setIcon("sap-icon://error");r.setType("Reject");sap.ui.getCore().getMessageManager().addMessages(f);U.close()}},downloadButton:function(){var e,t,a,s,i;if(!this._oTable){this._oTable=this.byId("iddialogmessageboxTable")}i=this._oTable;t=i.getBinding("items");e=this._createColumnConfig();a={workbook:{columns:e,hierarchyLevel:"Level"},dataSource:t,fileName:"Timesheet Entry logs.xlsx"};s=new f(a);s.build().finally(function(){s.destroy()})},_createColumnConfig:function(){var e=[];e.push({label:"Status",type:ne.String,property:"Status"});e.push({label:"Recorded Hours",property:"TimeSheetDate",type:ne.String});e.push({label:"Task Id",property:"Taskid",type:ne.String});e.push({label:"WBS Element",property:"Wbselement",type:ne.String});e.push({label:"Recorded Hours",property:"RecordedHours",type:ne.Number,scale:5});e.push({label:"Message",property:"Message",type:ne.String});return e},onMessagePopoverPress:function(e){var t=e.getSource();this._getMessagePopover().then(function(e){e.openBy(t)})},_getMessagePopover:function(){var e=this.getView();if(!this._pMessagePopover){this._pMessagePopover=T.load({id:e.getId(),name:"workforce.employeetimesheet.view.MessageManager"}).then(function(t){e.addDependent(t);return t})}return this._pMessagePopover},onupdatesubmit:async function(){Y=new sap.m.BusyDialog({title:"Processing Submission of Records",text:"Please wait....."});Y.open();var e=this.getOwnerComponent().getModel();e.setUseBatch(true);var t=[];var a=this;var s=sap.ui.core.format.DateFormat.getDateInstance({pattern:"yyyy-MM-dd"});var i=this.getView().byId("id_employee_extid");var r=this.getView().byId("id_wrkid_add");var n=this.getView().byId("daysTable");var o=n.getSelectedItems();if(o){for(var l=0;l<o.length;l++){var d={};var g=o[l].getCells();d.PersonWorkAgreementExternalID=i.getText();d.PersonWorkAgreement=G;var m=new Date(g[0].getValue());var u=s.format(m);d.TimeSheetDate=u+"T00:00:00";d.TimeSheetRecord=g[9].getText();d.CompanyCode=g[15].getText();d.TimeSheetOperation="U";d.TimeSheetStatus="30";d.TimeSheetIsReleasedOnSave=true;d.TimeSheetIsExecutedInTestRun=false;d.TimeSheetDataFields_TimeSheetTaskType=g[12].getText();d.TimeSheetDataFields_TimeSheetTaskComponent=g[10].getText();d.TimeSheetDataFields_TimeSheetTaskLevel=g[13].getText();d.TimeSheetDataFields_ReceiverCostCenter=g[11].getText();d.TimeSheetDataFields_RecordedHours=g[5].getText();d.TimeSheetDataFields_RecordedQuantity=g[5].getText();d.TimeSheetDataFields_ControllingArea=g[14].getText();d.TimeSheetDataFields_WBSElement=g[16].getText();d.TimeSheetDataFields_HoursUnitOfMeasure="H";t[l]=d;let r=await a._deleteallrecords(e,t[l])}a._logmessageError()}},templateChange:async function(e){var t=e.getSource(),a=t.getSelectedKey(),s=[],i=this,r=this.byId("id_add_employee_extid").getText(),n=this.getOwnerComponent().getModel("TimesheetPreviousService"),o=new sap.ui.model.Filter("PersonWorkAgreementExternalID","EQ",r);s.push(o);if(a=="1"){Z=new sap.m.BusyDialog({title:"loading Previous Timecard",text:"Please wait....."});Z.open();var l=new Date((new Date).getTime()-6048e5);i._getdates(l);if(le&&de){var d=le+"T00:00:00Z";var g=de+"T23:59:59Z";var m=new sap.ui.model.Filter("TimeSheetDate","BT",d,g);s.push(m)}let e=await i._getpreviousdata(n,s);if(e.length>0){var u=new Date;W=new sap.ui.model.json.JSONModel;i._getdates(u);let t=i._getDateRange(le,de);if(t){console.log(t);b=[];for(S=0;S<e.length;S++){console.log(new Date(e[S].TimeSheetDate));let a=t.filter(function(t){return t.Day===new Date(e[S].TimeSheetDate).getDay()});console.log(a[0].Date);var h={};h.Id=S;h.TimesheetDate=a[0].Date;h.TaskType=e[S].TimeSheetTaskType;h.WBSElemt="";h.RecordedHours=e[S].RecordedHours;h.RecordedQuantity=e[S].RecordedHours;b.push(h)}b.sort(function(e,t){var a=new Date(e.TimesheetDate);var s=new Date(t.TimesheetDate);return a-s});W.setData(b);i.getView().setModel(W,"Entries");W.refresh(true);Z.close();this.getView().byId("id_add_entrysave").setEnabled(true);this.getView().byId("id_add_entry_submit").setEnabled(true)}}}},_getpreviousdata:async function(e,t){return new Promise((a,s)=>{e.read("/MyTimesheetPreviousDetails",{filters:t,urlParameters:{$top:999999},success:function(e){console.log(e.results);a(e.results)}.bind(this),error:function(e){console.log(e)}.bind(this)})})},_getdates:function(e){var t=new Date(e);var a=t.getDay();var s,i;var r=sap.ui.core.format.DateFormat.getDateInstance({pattern:"yyyy-MM-dd"});if(a===6){s=t;i=new Date(new Date(t).getTime()+5184e5);le=r.format(s);de=r.format(i)}else if(a===5){s=new Date(new Date(t).getTime()-5184e5);i=t;le=r.format(s);de=r.format(i)}else if(a===4){s=new Date(new Date(t).getTime()-432e6);i=new Date(new Date(t).getTime()+864e5);le=r.format(s);de=r.format(i)}else if(a===3){s=new Date(new Date(t).getTime()-3456e5);i=new Date(new Date(t).getTime()+1728e5);le=r.format(s);de=r.format(i)}else if(a===2){s=new Date(new Date(t).getTime()-2592e5);i=new Date(new Date(t).getTime()+2592e5);le=r.format(s);de=r.format(i)}else if(a===1){s=new Date(new Date(t).getTime()-1728e5);i=new Date(new Date(t).getTime()+3456e5);le=r.format(s);de=r.format(i)}else if(a===0){s=new Date(new Date(t).getTime()-864e5);i=new Date(new Date(t).getTime()+432e6);le=r.format(s);de=r.format(i)}},_getDateRange:function(e,t){var a=0,s=[],i;var r={};r.Date=new Date(e);r.Day=new Date(e).getDay();s.push(r);do{let t={};if(a==0){i=new Date(new Date(e).getTime()+864e5)}else{i=new Date(i.getTime()+864e5)}t.Date=i;t.Day=i.getDay();s.push(t);a++}while(a<5);var r={};r.Date=new Date(t);r.Day=new Date(t).getDay();s.push(r);return s}})});
//# sourceMappingURL=timesheet_view.controller.js.map